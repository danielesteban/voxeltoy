!function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function r(e){return"function"==typeof e}function s(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let i,a;function c(e,t){return i||(i=document.createElement("a")),i.href=t,e===i.href}function l(t,...n){if(null==t)return e;const o=t.subscribe(...n);return o.unsubscribe?()=>o.unsubscribe():o}function u(e){let t;return l(e,(e=>t=e))(),t}function f(e,t,n){e.$$.on_destroy.push(l(t,n))}function d(e,t,n,o){if(e){const r=p(e,t,n,o);return e[0](r)}}function p(e,t,n,o){return e[1]&&o?function(e,t){for(const n in t)e[n]=t[n];return e}(n.ctx.slice(),e[1](o(t))):n.ctx}function v(e,t,n,o){if(e[2]&&o){const r=e[2](o(n));if(void 0===t.dirty)return r;if("object"==typeof r){const e=[],n=Math.max(t.dirty.length,r.length);for(let o=0;o<n;o+=1)e[o]=t.dirty[o]|r[o];return e}return t.dirty|r}return t.dirty}function h(e,t,n,o,r,s){if(r){const i=p(t,n,o,s);e.p(i,r)}}function m(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let e=0;e<n;e++)t[e]=-1;return t}return-1}function g(e,t,n){return e.set(n),t}function x(e,t){e.appendChild(t)}function y(e,t,n){e.insertBefore(t,n||null)}function b(e){e.parentNode.removeChild(e)}function w(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function z(e){return document.createElement(e)}function k(e){return document.createTextNode(e)}function $(){return k(" ")}function S(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function E(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function T(e){return""===e?null:+e}function M(e,t){t=""+t,e.wholeText!==t&&(e.data=t)}function _(e,t){e.value=null==t?"":t}function C(e,t,n,o){null===n?e.style.removeProperty(t):e.style.setProperty(t,n,o?"important":"")}function P(e,t,n){e.classList[n?"add":"remove"](t)}function A(e){a=e}function B(e){(function(){if(!a)throw new Error("Function called outside component initialization");return a})().$$.on_mount.push(e)}const U=[],I=[],L=[],R=[],N=Promise.resolve();let V=!1;function G(){V||(V=!0,N.then(j))}function O(){return G(),N}function F(e){L.push(e)}const q=new Set;let D=0;function j(){const e=a;do{for(;D<U.length;){const e=U[D];D++,A(e),Y(e.$$)}for(A(null),U.length=0,D=0;I.length;)I.pop()();for(let e=0;e<L.length;e+=1){const t=L[e];q.has(t)||(q.add(t),t())}L.length=0}while(U.length);for(;R.length;)R.pop()();V=!1,q.clear(),A(e)}function Y(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(F)}}const X=new Set;let W;function Z(){W={r:0,c:[],p:W}}function H(){W.r||o(W.c),W=W.p}function J(e,t){e&&e.i&&(X.delete(e),e.i(t))}function K(e,t,n,o){if(e&&e.o){if(X.has(e))return;X.add(e),W.c.push((()=>{X.delete(e),o&&(n&&e.d(1),o())})),e.o(t)}else o&&o()}const Q="undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:global;function ee(e,t){e.d(1),t.delete(e.key)}function te(e){e&&e.c()}function ne(e,n,s,i){const{fragment:a,on_mount:c,on_destroy:l,after_update:u}=e.$$;a&&a.m(n,s),i||F((()=>{const n=c.map(t).filter(r);l?l.push(...n):o(n),e.$$.on_mount=[]})),u.forEach(F)}function oe(e,t){const n=e.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function re(t,r,s,i,c,l,u,f=[-1]){const d=a;A(t);const p=t.$$={fragment:null,ctx:null,props:l,update:e,not_equal:c,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(r.context||(d?d.$$.context:[])),callbacks:n(),dirty:f,skip_bound:!1,root:r.target||d.$$.root};u&&u(p.root);let v=!1;if(p.ctx=s?s(t,r.props||{},((e,n,...o)=>{const r=o.length?o[0]:n;return p.ctx&&c(p.ctx[e],p.ctx[e]=r)&&(!p.skip_bound&&p.bound[e]&&p.bound[e](r),v&&function(e,t){-1===e.$$.dirty[0]&&(U.push(e),G(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}(t,e)),n})):[],p.update(),v=!0,o(p.before_update),p.fragment=!!i&&i(p.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);p.fragment&&p.fragment.l(e),e.forEach(b)}else p.fragment&&p.fragment.c();r.intro&&J(t.$$.fragment),ne(t,r.target,r.anchor,r.customElement),j()}A(d)}class se{$destroy(){oe(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const ie=[];function ae(t,n=e){let o;const r=new Set;function i(e){if(s(t,e)&&(t=e,o)){const e=!ie.length;for(const e of r)e[1](),ie.push(e,t);if(e){for(let e=0;e<ie.length;e+=2)ie[e][0](ie[e+1]);ie.length=0}}}return{set:i,update:function(e){i(e(t))},subscribe:function(s,a=e){const c=[s,a];return r.add(c),1===r.size&&(o=n(i)||e),s(t),()=>{r.delete(c),0===r.size&&(o(),o=null)}}}}var ce="fn getColorAt(texture : i32, pixel : vec2<i32>) -> vec4<f32> {\n  var h : f32 = f32(texture) / f32(atlas.count);\n  var s : f32 = 0.5;\n  var l : f32 = 0.5;\n  if (\n    pixel.x == 0 || pixel.x == (atlas.width - 1)\n    || pixel.y == 0 || pixel.y == (atlas.height - 1)\n  ) {\n    l = min(l * 1.1, 1);\n  }\n  return hsl2Rgba(h, s, l);\n}\n";const le=["// VoxelToy\n\n// SDF primitives\n// sdBox(p : vec3<f32>, r : vec3<f32>) -> f32\n// sdCapsule(p : vec3<f32>, r : vec3<f32>) -> f32\n// sdEllipsoid(p : vec3<f32>, r : vec3<f32>) -> f32\n// sdSphere(p : vec3<f32>, r : f32) -> f32\n// sdTorus(p : vec3<f32>, r : vec2<f32>) -> f32\n\n// SDF operations\n// opUnion(d1 : f32, d2 : f32) -> f32\n// opSubstraction(d1 : f32, d2 : f32) -> f32\n// opSmoothUnion(d1 : f32, d2 : f32, k : f32) -> f32\n// opSmoothSubstraction(d1 : f32, d2 : f32, k : f32) -> f32\n\n// Noise functions\n// noise3(p: vec3<f32>) -> f32\n// simplexNoise3(v: vec3<f32>) -> f32\n\n// Rotation helpers\n// rotateX(rad : f32) -> mat3x3<f32>\n// rotateY(rad : f32) -> mat3x3<f32>\n// rotateZ(rad : f32) -> mat3x3<f32>\n\n// Variables\n// time : f32\n// volume.size : vec3<f32>\n// volume.center : vec3<f32>\n\nfn distanceToScene(pos : vec3<f32>) -> f32 {\n  var origin : vec3<f32> = pos - volume.center;\n  var t : f32 = sin(time * 2);\n  var size : f32 = volume.size.x * (0.25 + t * 0.01);\n  return opSmoothUnion(\n    sdSphere(origin - vec3<f32>(size * (0.6 * t * -1), size * 0.2 * t * -1, 0), size),\n    sdSphere(origin - vec3<f32>(size * (0.6 * t), size * 0.2 * t, 0), size),\n    10\n  );\n}\n\nfn getValueAt(pos : vec3<f32>) -> f32 {\n  if (distanceToScene(pos) > 0.01) {\n    return 0;\n  }\n  return 1 + abs(simplexNoise3(pos * 0.01)) * 254;\n}\n","fn distanceToScene(pos : vec3<f32>) -> f32 {\n  var origin : vec3<f32> = pos - volume.center;\n  var r : mat3x3<f32> = rotateX(PI * -0.5);\n  return opUnion(\n    sdTorus(\n      r * origin,\n      vec2<f32>(volume.size.x * 0.3, volume.size.x * 0.1)\n    ),\n    sdTorus(\n      r * rotateY(time) * origin,\n      vec2<f32>(volume.size.x * 0.1, volume.size.x * (0.02 + sin(time * 10) * 0.01))\n    )\n  );\n}\n\nfn getValueAt(pos : vec3<f32>) -> f32 {\n  if (distanceToScene(pos) > 0.01) {\n    return 0;\n  }\n  return 1 + abs(simplexNoise3(pos * 0.01)) * 254;\n}\n","fn getValueAt(pos : vec3<f32>) -> f32 {\n  var p : vec3<f32> = pos + vec3<f32>(0, 0, round(time * 100));\n  var h : f32 = abs(simplexNoise3(p * 0.01)) * volume.size.y;\n  if (pos.y > h) {\n    return 0;\n  }\n  return 1 + abs(simplexNoise3(p * -0.001)) * 254;\n}\n","fn distanceToScene(pos : vec3<f32>) -> f32 {\n  if (sdSphere(pos - volume.center, volume.size.x * 0.35) > 0.01) {\n    return 1;\n  }\n  var id : f32 = noise3(floor(pos / 32));\n  var p : vec3<f32> = (pos % 32) - 16;\n  var t : f32 = sin((time + id) * 4);\n  var d : f32;\n  if (floor(id * 10) % 2 == 0) {\n    d = sdSphere(p, t * 4 + 8);\n  } else {\n    d = sdBox(p, vec3<f32>(t * 4 + 8));\n  }\n  return opSmoothSubstraction(\n    opSmoothSubstraction(\n      d,\n      sdBox(p, vec3<f32>(4, 4, 12)),\n      1\n    ),\n    sdBox(p, vec3<f32>(12, 4, 4)),\n    1\n  );\n}\n\nfn getValueAt(pos : vec3<f32>) -> f32 {\n  if (distanceToScene(pos) > 0.01) {\n    return 0;\n  }\n  return 1 + abs(simplexNoise3(floor(pos / 32))) * 254;\n}\n"],ue=ae("scene"),fe={errors:ae([]),source:ae(ce)},de={background:ae("#000000"),effects:{edges:{color:ae("#000000"),intensity:ae(.3)}},gpu:null,resolution:ae(200)},pe={errors:ae([]),source:ae(le[0])},ve={id:ae(""),author:ae(""),title:ae("Untitled")},he=e=>{delete fe.editor,fe.source.set(e.atlas||ce),de.background.set(`#${("000000"+(e.background||0).toString(16)).slice(-6)}`),de.effects.edges.color.set(`#${("000000"+(e.edgesColor||0).toString(16)).slice(-6)}`),de.effects.edges.intensity.set(void 0!==e.edgesIntensity?e.edgesIntensity:.3),de.resolution.set(e.resolution||200),delete pe.editor,pe.source.set(e.scene),ve.id.set(e.id||""),ve.author.set(e.author||""),ve.title.set(e.title||"Untitled")},me=()=>({atlas:u(fe.source),background:parseInt(u(de.background).slice(1),16),edgesColor:parseInt(u(de.effects.edges.color).slice(1),16),edgesIntensity:u(de.effects.edges.intensity),resolution:u(de.resolution),scene:u(pe.source),title:u(ve.title)}),ge="https://voxeltoy-server.gatunes.com/",xe=({body:e,endpoint:t,method:n="GET",session:o,signal:r})=>{let s;return!e||e instanceof FormData||(s="application/json",e=JSON.stringify(e)),fetch(`${ge}${t}`,{headers:{...o?{Authorization:`Bearer ${o}`}:{},...s?{"Content-Type":s}:{}},body:e,method:n,signal:r}).then((e=>{const{status:t}=e;if(t<200||t>=400)throw new Error(t);return 0===(e.headers.get("content-type")||"").indexOf("application/json")?e.json():e.arrayBuffer()}))},ye=(()=>{const e="voxeltoy:session";let t=localStorage.getItem(e)||!1;if(t)try{t=JSON.parse(t)}catch(e){t=!1}const{subscribe:n,set:o}=ae(t),r=t=>{o(t),t?localStorage.setItem(e,JSON.stringify(t)):localStorage.removeItem(e)};return t&&xe({endpoint:"user",session:t.session}).then(r).catch((()=>r(!1))),{subscribe:n,set:r}})(),be={create:e=>xe({body:e,endpoint:"scene",method:"POST",session:u(ye).session}),load:(e,t)=>xe({endpoint:`scene/${e}`,method:"GET",signal:t}),list:(e,t)=>xe({endpoint:`scenes/${e}`,method:"GET",signal:t}),update:(e,t)=>xe({body:t,endpoint:`scene/${e}`,method:"PUT",session:u(ye).session})},we={login:({email:e,password:t})=>xe({body:{email:e,password:t},endpoint:"user",method:"PUT"}).then((e=>ye.set(e))),logout(){ye.set(!1)},register:({email:e,name:t,password:n})=>xe({body:{email:e,name:t,password:n},endpoint:"user",method:"POST"}).then((e=>ye.set(e)))};function ze(e,t,n){const o=e.slice();return o[11]=t[n].lineNum,o[12]=t[n].linePos,o[13]=t[n].type,o[14]=t[n].message,o[15]=t[n].line,o[16]=t[n].pointer,o}function ke(e){let t,n,o,r,s,i,a,c,l,u,f,d,p,v,h,m,g,w=e[11]+"",S=e[12]+"",T=e[13]+"",_=e[14]+"",C=e[15]+"",P=e[16]+"";return{c(){t=z("div"),n=z("div"),o=k(":"),r=k(w),s=k(":"),i=k(S),a=$(),c=k(T),l=k(": "),u=k(_),f=$(),d=z("div"),p=k(C),v=$(),h=z("div"),m=k(P),g=$(),E(n,"class","svelte-gxob7"),E(d,"class","svelte-gxob7"),E(h,"class","svelte-gxob7"),E(t,"class","svelte-gxob7")},m(e,b){y(e,t,b),x(t,n),x(n,o),x(n,r),x(n,s),x(n,i),x(n,a),x(n,c),x(n,l),x(n,u),x(t,f),x(t,d),x(d,p),x(t,v),x(t,h),x(h,m),x(t,g)},p(e,t){4&t&&w!==(w=e[11]+"")&&M(r,w),4&t&&S!==(S=e[12]+"")&&M(i,S),4&t&&T!==(T=e[13]+"")&&M(c,T),4&t&&_!==(_=e[14]+"")&&M(u,_),4&t&&C!==(C=e[15]+"")&&M(p,C),4&t&&P!==(P=e[16]+"")&&M(m,P)},d(e){e&&b(t)}}}function $e(t){let n,o,r,s,i,a,c,l,u,f,d,p,v,h,m=t[2].length+"",g=t[2],T=[];for(let e=0;e<g.length;e+=1)T[e]=ke(ze(t,g,e));return{c(){n=z("div"),o=z("div"),r=$(),s=z("div"),i=z("div"),a=z("div"),c=$(),l=k(m),u=k(" errors\n      "),f=z("div"),d=$(),p=z("div");for(let e=0;e<T.length;e+=1)T[e].c();E(o,"class","wrapper svelte-gxob7"),E(a,"class","status svelte-gxob7"),P(a,"error",t[2].length),E(f,"class","arrow svelte-gxob7"),E(i,"class","toggle svelte-gxob7"),E(p,"class","messages svelte-gxob7"),E(s,"class","errors svelte-gxob7"),P(s,"open",t[1]),E(n,"class","editor svelte-gxob7")},m(e,m){y(e,n,m),x(n,o),t[7](o),x(n,r),x(n,s),x(s,i),x(i,a),x(i,c),x(i,l),x(i,u),x(i,f),x(s,d),x(s,p);for(let e=0;e<T.length;e+=1)T[e].m(p,null);v||(h=S(i,"click",t[5]),v=!0)},p(e,[t]){if(4&t&&P(a,"error",e[2].length),4&t&&m!==(m=e[2].length+"")&&M(l,m),4&t){let n;for(g=e[2],n=0;n<g.length;n+=1){const o=ze(e,g,n);T[n]?T[n].p(o,t):(T[n]=ke(o),T[n].c(),T[n].m(p,null))}for(;n<T.length;n+=1)T[n].d(1);T.length=g.length}2&t&&P(s,"open",e[1])},i:e,o:e,d(e){e&&b(n),t[7](null),w(T,e),v=!1,h()}}}function Se(e,t,n){let o,r,{state:s}=t;const{errors:i,source:a}=s;let c,l;f(e,i,(e=>n(2,r=e))),f(e,a,(e=>n(9,o=e)));let u=!1;const d=()=>l.layout();return B((()=>{let e,t=!0;if(l=monaco.editor.create(c,{minimap:{enabled:!1},theme:"vs-dark"}),s.editor){const{model:e,view:t}=s.editor;l.setModel(e),l.restoreViewState(t)}else l.setModel(monaco.editor.createModel(o,"c"));const r=[i.subscribe((e=>{monaco.editor.setModelMarkers(l.getModel(),"Errors",e.map((({lineNum:e,linePos:t,length:n,message:o})=>({message:o,startLineNumber:e,endLineNumber:e,startColumn:t,endColumn:t+n}))))})),a.subscribe((e=>{t||l.setValue(e)}))];return t=!1,l.onDidChangeModelContent((()=>{e&&clearTimeout(e),e=setTimeout((()=>{t=!0,a.set(l.getValue()),t=!1}),300)})),l.focus(),window.addEventListener("resize",d,!1),()=>{n(6,s.editor={model:l.getModel(),view:l.saveViewState()},s),l.dispose(),clearTimeout(e),window.removeEventListener("resize",d),r.forEach((e=>e()))}})),e.$$set=e=>{"state"in e&&n(6,s=e.state)},[c,u,r,i,a,()=>{n(1,u=!u),O().then(d)},s,function(e){I[e?"unshift":"push"]((()=>{c=e,n(0,c)}))}]}class Ee extends se{constructor(e){super(),re(this,e,Se,$e,s,{state:6})}}function Te(t){let n,o;return n=new Ee({props:{state:fe}}),{c(){te(n.$$.fragment)},m(e,t){ne(n,e,t),o=!0},p:e,i(e){o||(J(n.$$.fragment,e),o=!0)},o(e){K(n.$$.fragment,e),o=!1},d(e){oe(n,e)}}}class Me extends se{constructor(e){super(),re(this,e,null,Te,s,{})}}function _e(e,t,n){const o=e.slice();return o[2]=t[n].id,o[3]=t[n].author,o[4]=t[n].title,o}function Ce(e,t){let n,o,s,i,a,l,u,f,d,p,v,h,m,g,w=t[4]+"",T=t[3]+"";return{key:e,first:null,c(){n=z("div"),o=z("img"),a=$(),l=z("div"),u=k(w),f=$(),d=z("span"),p=k("by "),v=k(T),h=$(),E(o,"alt",s=t[4]),E(o,"crossorigin","anonymous"),c(o.src,i=ge+"scene/"+t[2]+"/screenshot")||E(o,"src",i),E(o,"class","svelte-1v4n0mg"),E(d,"class","svelte-1v4n0mg"),E(l,"class","svelte-1v4n0mg"),E(n,"class","item svelte-1v4n0mg"),this.first=n},m(e,s){y(e,n,s),x(n,o),x(n,a),x(n,l),x(l,u),x(l,f),x(l,d),x(d,p),x(d,v),x(n,h),m||(g=S(n,"click",(function(){r(t[1](t[2]))&&t[1](t[2]).apply(this,arguments)})),m=!0)},p(e,n){t=e,1&n&&s!==(s=t[4])&&E(o,"alt",s),1&n&&!c(o.src,i=ge+"scene/"+t[2]+"/screenshot")&&E(o,"src",i),1&n&&w!==(w=t[4]+"")&&M(u,w),1&n&&T!==(T=t[3]+"")&&M(v,T)},d(e){e&&b(n),m=!1,g()}}}function Pe(t){let n,o=[],r=new Map,s=t[0];const i=e=>e[2];for(let e=0;e<s.length;e+=1){let n=_e(t,s,e),a=i(n);r.set(a,o[e]=Ce(a,n))}return{c(){n=z("div");for(let e=0;e<o.length;e+=1)o[e].c();E(n,"class","wrapper svelte-1v4n0mg")},m(e,t){y(e,n,t);for(let e=0;e<o.length;e+=1)o[e].m(n,null)},p(e,[t]){3&t&&(s=e[0],o=function(e,t,n,o,r,s,i,a,c,l,u,f){let d=e.length,p=s.length,v=d;const h={};for(;v--;)h[e[v].key]=v;const m=[],g=new Map,x=new Map;for(v=p;v--;){const e=f(r,s,v),a=n(e);let c=i.get(a);c?o&&c.p(e,t):(c=l(a,e),c.c()),g.set(a,m[v]=c),a in h&&x.set(a,Math.abs(v-h[a]))}const y=new Set,b=new Set;function w(e){J(e,1),e.m(a,u),i.set(e.key,e),u=e.first,p--}for(;d&&p;){const t=m[p-1],n=e[d-1],o=t.key,r=n.key;t===n?(u=t.first,d--,p--):g.has(r)?!i.has(o)||y.has(o)?w(t):b.has(r)?d--:x.get(o)>x.get(r)?(b.add(o),w(t)):(y.add(r),d--):(c(n,i),d--)}for(;d--;){const t=e[d];g.has(t.key)||c(t,i)}for(;p;)w(m[p-1]);return m}(o,t,i,1,e,s,r,n,ee,Ce,null,_e))},i:e,o:e,d(e){e&&b(n);for(let e=0;e<o.length;e+=1)o[e].d()}}}function Ae(e,t,n){let o=[];return B((()=>{const e=new AbortController;return be.list(0,e.signal).then((({pages:e,scenes:t})=>{n(0,o=t)})).catch((()=>{})),()=>{e.abort()}})),[o,e=>()=>{location.hash=`/${e}`}]}class Be extends se{constructor(e){super(),re(this,e,Ae,Pe,s,{})}}function Ue(e){let t,n,o,r,s,i;return{c(){t=z("div"),n=z("label"),n.textContent="Name:",o=$(),r=z("input"),E(n,"for","name"),E(n,"class","svelte-1a5owim"),E(r,"autocomplete","off"),E(r,"id","name"),E(r,"type","text"),r.required=!0,E(r,"class","svelte-1a5owim"),E(t,"class","input svelte-1a5owim")},m(a,c){y(a,t,c),x(t,n),x(t,o),x(t,r),_(r,e[1]),s||(i=S(r,"input",e[11]),s=!0)},p(e,t){2&t&&r.value!==e[1]&&_(r,e[1])},d(e){e&&b(t),s=!1,i()}}}function Ie(e){let t;return{c(){t=z("div"),t.textContent="There was an error",E(t,"class","error svelte-1a5owim")},m(e,n){y(e,t,n)},d(e){e&&b(t)}}}function Le(e){let t;return{c(){t=k("Login")},m(e,n){y(e,t,n)},d(e){e&&b(t)}}}function Re(e){let t;return{c(){t=k("Register")},m(e,n){y(e,t,n)},d(e){e&&b(t)}}}function Ne(t){let n,o,r;return{c(){n=z("a"),n.textContent="Need an account?",E(n,"class","svelte-1a5owim")},m(e,s){y(e,n,s),o||(r=S(n,"click",t[8]),o=!0)},p:e,d(e){e&&b(n),o=!1,r()}}}function Ve(t){let n,o,r;return{c(){n=z("a"),n.textContent="Already have an account?",E(n,"class","svelte-1a5owim")},m(e,s){y(e,n,s),o||(r=S(n,"click",t[6]),o=!0)},p:e,d(e){e&&b(n),o=!1,r()}}}function Ge(t){let n,s,i,a,c,l,u,f,d,p,v,h,m,g,w,k,T,M,C,P,A=t[5]&&Ue(t),B=t[3]&&Ie();function U(e,t){return e[5]?Re:Le}let I=U(t),L=I(t);function R(e,t){return e[5]?Ve:Ne}let N=R(t),V=N(t);return{c(){n=z("form"),s=z("div"),i=z("label"),i.textContent="Email:",a=$(),c=z("input"),l=$(),A&&A.c(),u=$(),f=z("div"),d=z("label"),d.textContent="Password:",p=$(),v=z("input"),m=$(),B&&B.c(),g=$(),w=z("div"),k=z("button"),L.c(),T=$(),M=z("div"),V.c(),E(i,"for","email"),E(i,"class","svelte-1a5owim"),E(c,"autocomplete","username"),E(c,"id","email"),E(c,"type","email"),c.required=!0,E(c,"class","svelte-1a5owim"),E(s,"class","input svelte-1a5owim"),E(d,"for","password"),E(d,"class","svelte-1a5owim"),E(v,"autocomplete",h=t[5]?"current-password":"new-password"),E(v,"id","password"),E(v,"type","password"),v.required=!0,E(v,"class","svelte-1a5owim"),E(f,"class","input svelte-1a5owim"),E(k,"type","submit"),k.disabled=t[4],E(k,"class","svelte-1a5owim"),E(w,"class","submit svelte-1a5owim"),E(M,"class","alternative svelte-1a5owim"),E(n,"class","svelte-1a5owim")},m(e,o){y(e,n,o),x(n,s),x(s,i),x(s,a),x(s,c),_(c,t[0]),x(n,l),A&&A.m(n,null),x(n,u),x(n,f),x(f,d),x(f,p),x(f,v),_(v,t[2]),x(n,m),B&&B.m(n,null),x(n,g),x(n,w),x(w,k),L.m(k,null),x(n,T),x(n,M),V.m(M,null),C||(P=[S(c,"input",t[10]),S(v,"input",t[12]),S(n,"submit",(function(){r(t[5]?t[9]:t[7])&&(t[5]?t[9]:t[7]).apply(this,arguments)}))],C=!0)},p(e,[o]){t=e,1&o&&c.value!==t[0]&&_(c,t[0]),t[5]?A?A.p(t,o):(A=Ue(t),A.c(),A.m(n,u)):A&&(A.d(1),A=null),32&o&&h!==(h=t[5]?"current-password":"new-password")&&E(v,"autocomplete",h),4&o&&v.value!==t[2]&&_(v,t[2]),t[3]?B||(B=Ie(),B.c(),B.m(n,g)):B&&(B.d(1),B=null),I!==(I=U(t))&&(L.d(1),L=I(t),L&&(L.c(),L.m(k,null))),16&o&&(k.disabled=t[4]),N===(N=R(t))&&V?V.p(t,o):(V.d(1),V=N(t),V&&(V.c(),V.m(M,null)))},i:e,o:e,d(e){e&&b(n),A&&A.d(),B&&B.d(),L.d(),V.d(),C=!1,o(P)}}}function Oe(e,t,n){let o="",r="",s="",i=!1,a=!1,c=!1;return[o,r,s,i,a,c,()=>{n(5,c=!1)},e=>{e.preventDefault(),n(3,i=!1),n(4,a=!0),we.login({email:o,password:s}).catch((()=>{n(3,i=!0)})).finally((()=>{n(4,a=!1)}))},()=>{n(5,c=!0)},e=>{e.preventDefault(),n(3,i=!1),n(4,a=!0),we.register({email:o,name:r,password:s}).catch((()=>{n(3,i=!0)})).finally((()=>{n(4,a=!1)}))},function(){o=this.value,n(0,o)},function(){r=this.value,n(1,r)},function(){s=this.value,n(2,s)}]}class Fe extends se{constructor(e){super(),re(this,e,Oe,Ge,s,{})}}function qe(t){let n,o;return n=new Fe({}),{c(){te(n.$$.fragment)},m(e,t){ne(n,e,t),o=!0},p:e,i(e){o||(J(n.$$.fragment,e),o=!0)},o(e){K(n.$$.fragment,e),o=!1},d(e){oe(n,e)}}}function De(t){let n,r,s,i,a,c,l,u,f,d,p,v,h,m,g,w,T,M,C=t[6]?"Update":"Publish",P=t[7]&&function(t){let n,o,r,s;return{c(){n=z("div"),o=z("label"),o.textContent="Screenshot:",r=$(),s=z("div"),E(o,"for","name"),E(o,"class","svelte-1g9w4jk"),E(s,"class","image svelte-1g9w4jk"),E(s,"style",t[7]?`background-image: url(${t[7]})`:""),E(n,"class","input screenshot svelte-1g9w4jk")},m(e,t){y(e,n,t),x(n,o),x(n,r),x(n,s)},p:e,d(e){e&&b(n)}}}(t);return{c(){n=z("form"),r=z("div"),s=z("label"),s.textContent="Author:",i=$(),a=z("input"),l=$(),u=z("div"),f=z("label"),f.textContent="Title:",d=$(),p=z("input"),v=$(),P&&P.c(),h=$(),m=z("div"),g=z("button"),w=k(C),E(s,"for","author"),E(s,"class","svelte-1g9w4jk"),a.value=c=t[1].name,E(a,"autocomplete","off"),E(a,"id","author"),E(a,"type","text"),a.disabled=!0,E(a,"class","svelte-1g9w4jk"),E(r,"class","input svelte-1g9w4jk"),E(f,"for","title"),E(f,"class","svelte-1g9w4jk"),E(p,"autocomplete","off"),E(p,"id","title"),E(p,"type","text"),p.required=!0,E(p,"class","svelte-1g9w4jk"),E(u,"class","input svelte-1g9w4jk"),E(g,"type","submit"),g.disabled=t[0],E(g,"class","svelte-1g9w4jk"),E(m,"class","submit svelte-1g9w4jk"),E(n,"class","svelte-1g9w4jk")},m(e,o){y(e,n,o),x(n,r),x(r,s),x(r,i),x(r,a),x(n,l),x(n,u),x(u,f),x(u,d),x(u,p),_(p,t[2]),x(n,v),P&&P.m(n,null),x(n,h),x(n,m),x(m,g),x(g,w),T||(M=[S(p,"input",t[9]),S(n,"submit",t[8])],T=!0)},p(e,t){2&t&&c!==(c=e[1].name)&&a.value!==c&&(a.value=c),4&t&&p.value!==e[2]&&_(p,e[2]),e[7]&&P.p(e,t),1&t&&(g.disabled=e[0])},i:e,o:e,d(e){e&&b(n),P&&P.d(),T=!1,o(M)}}}function je(e){let t,n,o,r;const s=[De,qe],i=[];function a(e,t){return e[1]?0:1}return n=a(e),o=i[n]=s[n](e),{c(){t=z("div"),o.c(),E(t,"class","wrapper svelte-1g9w4jk")},m(e,o){y(e,t,o),i[n].m(t,null),r=!0},p(e,[r]){let c=n;n=a(e),n===c?i[n].p(e,r):(Z(),K(i[c],1,1,(()=>{i[c]=null})),H(),o=i[n],o?o.p(e,r):(o=i[n]=s[n](e),o.c()),J(o,1),o.m(t,null))},i(e){r||(J(o),r=!0)},o(e){K(o),r=!1},d(e){e&&b(t),i[n].d()}}}function Ye(e,t,n){let o,r,s,i;f(e,ye,(e=>n(1,r=e)));const{id:a,author:c,title:l}=ve;f(e,a,(e=>n(10,o=e))),f(e,c,(e=>n(11,s=e))),f(e,l,(e=>n(2,i=e)));let u=!1,d=o&&s===r.name;const p=!d&&de.screenshot();return[u,r,i,a,c,l,d,p,e=>{e.preventDefault(),n(0,u=!0),(d?be.update(o,me()):be.create({...me(),screenshot:p?p.slice(22):void 0})).then((()=>{location.hash="/gallery"})).catch((()=>{}))},function(){i=this.value,l.set(i)}]}class Xe extends se{constructor(e){super(),re(this,e,Ye,je,s,{})}}function We(e,t,n){const o=e.slice();return o[13]=t[n],o}function Ze(e){let t,n,o,r,s,i,a=e[13]+"";return{c(){t=z("div"),n=k(a),o=z("span"),o.textContent="3",r=$(),E(o,"class","svelte-13uax2i"),E(t,"class","svelte-13uax2i"),P(t,"enabled",e[13]===e[0])},m(a,c){y(a,t,c),x(t,n),x(t,o),x(t,r),s||(i=S(t,"click",e[9](e[13])),s=!0)},p(n,o){e=n,257&o&&P(t,"enabled",e[13]===e[0])},d(e){e&&b(t),s=!1,i()}}}function He(t){let n,r,s,i,a,c,l,u,f,d,p,v,h,m,g,k,M,C,P,A,B,U,I,L,R,N,V=t[8],G=[];for(let e=0;e<V.length;e+=1)G[e]=Ze(We(t,V,e));return{c(){n=z("div"),r=z("div"),s=z("label"),s.textContent="Background:",i=$(),a=z("input"),c=$(),l=z("div"),u=z("label"),u.textContent="Resolution:",f=$(),d=z("div");for(let e=0;e<G.length;e+=1)G[e].c();p=$(),v=z("h4"),v.textContent="Effects",h=$(),m=z("h5"),m.textContent="Edges",g=$(),k=z("div"),M=z("label"),M.textContent="Color:",C=$(),P=z("input"),A=$(),B=z("div"),U=z("label"),U.textContent="Intensity:",I=$(),L=z("input"),E(s,"for","background"),E(s,"class","svelte-13uax2i"),E(a,"id","background"),E(a,"type","color"),E(a,"class","svelte-13uax2i"),E(r,"class","input svelte-13uax2i"),E(u,"for","resolution"),E(u,"class","svelte-13uax2i"),E(d,"class","resolution svelte-13uax2i"),E(l,"class","input svelte-13uax2i"),E(v,"class","svelte-13uax2i"),E(m,"class","svelte-13uax2i"),E(M,"for","edgesColor"),E(M,"class","svelte-13uax2i"),E(P,"id","edgesColor"),E(P,"type","color"),E(P,"class","svelte-13uax2i"),E(k,"class","input svelte-13uax2i"),E(U,"for","edgesIntensity"),E(U,"class","svelte-13uax2i"),E(L,"id","edgesIntensity"),E(L,"type","number"),E(L,"min",0),E(L,"max",1),E(L,"step",.01),E(L,"class","svelte-13uax2i"),E(B,"class","input svelte-13uax2i"),E(n,"class","wrapper svelte-13uax2i")},m(e,o){y(e,n,o),x(n,r),x(r,s),x(r,i),x(r,a),_(a,t[1]),x(n,c),x(n,l),x(l,u),x(l,f),x(l,d);for(let e=0;e<G.length;e+=1)G[e].m(d,null);x(n,p),x(n,v),x(n,h),x(n,m),x(n,g),x(n,k),x(k,M),x(k,C),x(k,P),_(P,t[2]),x(n,A),x(n,B),x(B,U),x(B,I),x(B,L),_(L,t[3]),R||(N=[S(a,"input",t[10]),S(P,"input",t[11]),S(L,"input",t[12])],R=!0)},p(e,[t]){if(2&t&&_(a,e[1]),769&t){let n;for(V=e[8],n=0;n<V.length;n+=1){const o=We(e,V,n);G[n]?G[n].p(o,t):(G[n]=Ze(o),G[n].c(),G[n].m(d,null))}for(;n<G.length;n+=1)G[n].d(1);G.length=V.length}4&t&&_(P,e[2]),8&t&&T(L.value)!==e[3]&&_(L,e[3])},i:e,o:e,d(e){e&&b(n),w(G,e),R=!1,o(N)}}}function Je(e,t,n){let o,r,s,i;const{background:a,effects:{edges:{color:c,intensity:l}},resolution:u}=de;f(e,a,(e=>n(1,r=e))),f(e,c,(e=>n(2,s=e))),f(e,l,(e=>n(3,i=e))),f(e,u,(e=>n(0,o=e)));return[o,r,s,i,a,c,l,u,[100,200,300,400],e=>()=>{g(u,o=e,o)},function(){r=this.value,a.set(r)},function(){s=this.value,c.set(s)},function(){i=T(this.value),l.set(i)}]}class Ke extends se{constructor(e){super(),re(this,e,Je,He,s,{})}}function Qe(t){let n,o;return n=new Ee({props:{state:pe}}),{c(){te(n.$$.fragment)},m(e,t){ne(n,e,t),o=!0},p:e,i(e){o||(J(n.$$.fragment,e),o=!0)},o(e){K(n.$$.fragment,e),o=!1},d(e){oe(n,e)}}}class et extends se{constructor(e){super(),re(this,e,null,Qe,s,{})}}const tt=e=>({}),nt=e=>({}),ot=e=>({}),rt=e=>({});function st(e){let t,n,o,r;const s=e[1].toggle,i=d(s,e,e[0],rt),a=e[1].options,c=d(a,e,e[0],nt);return{c(){t=z("div"),i&&i.c(),n=$(),o=z("div"),c&&c.c(),E(o,"class","options svelte-7xzgh1"),E(t,"class","dropdown svelte-7xzgh1")},m(e,s){y(e,t,s),i&&i.m(t,null),x(t,n),x(t,o),c&&c.m(o,null),r=!0},p(e,[t]){i&&i.p&&(!r||1&t)&&h(i,s,e,e[0],r?v(s,e[0],t,ot):m(e[0]),rt),c&&c.p&&(!r||1&t)&&h(c,a,e,e[0],r?v(a,e[0],t,tt):m(e[0]),nt)},i(e){r||(J(i,e),J(c,e),r=!0)},o(e){K(i,e),K(c,e),r=!1},d(e){e&&b(t),i&&i.d(e),c&&c.d(e)}}}function it(e,t,n){let{$$slots:o={},$$scope:r}=t;return e.$$set=e=>{"$$scope"in e&&n(0,r=e.$$scope)},[r,o]}class at extends se{constructor(e){super(),re(this,e,it,st,s,{})}}function ct(e,t,n){const o=e.slice();return o[16]=t[n].id,o[19]=t[n].name,o}function lt(e,t,n){const o=e.slice();return o[22]=t[n],o[24]=n,o}function ut(e){let t,n,o,r,s,i,a,c=(e[4]?e[4]:e[5]?e[5].name:"anonymous")+"";return{c(){t=z("a"),t.textContent="Voxeltoy",n=k("\n      > "),o=k(e[3]),r=k(" by "),s=k(c),E(t,"class","svelte-oktwv0")},m(c,l){y(c,t,l),y(c,n,l),y(c,o,l),y(c,r,l),y(c,s,l),i||(a=S(t,"click",e[13]),i=!0)},p(e,t){8&t&&M(o,e[3]),48&t&&c!==(c=(e[4]?e[4]:e[5]?e[5].name:"anonymous")+"")&&M(s,c)},d(e){e&&b(t),e&&b(n),e&&b(o),e&&b(r),e&&b(s),i=!1,a()}}}function ft(t){let n;return{c(){n=k("Voxeltoy")},m(e,t){y(e,n,t)},p:e,d(e){e&&b(n)}}}function dt(e){let t,n,o,r,s,i,a,c,l,u;o=new at({props:{$$slots:{options:[ht],toggle:[pt]},$$scope:{ctx:e}}});let f=e[7],d=[];for(let t=0;t<f.length;t+=1)d[t]=mt(ct(e,f,t));function p(e,t){return e[6]&&e[5]&&e[4]===e[5].name?xt:gt}let v=p(e),h=v(e);return{c(){t=z("div"),n=z("div"),te(o.$$.fragment),r=$();for(let e=0;e<d.length;e+=1)d[e].c();s=$(),i=z("div"),a=z("div"),h.c(),E(n,"class","svelte-oktwv0"),E(a,"class","view svelte-oktwv0"),P(a,"enabled","publish"===e[2]),E(i,"class","svelte-oktwv0"),E(t,"class","toolbar svelte-oktwv0")},m(f,p){y(f,t,p),x(t,n),ne(o,n,null),x(n,r);for(let e=0;e<d.length;e+=1)d[e].m(n,null);x(t,s),x(t,i),x(i,a),h.m(a,null),c=!0,l||(u=S(a,"click",e[8]("publish")),l=!0)},p(e,t){const r={};if(33554432&t&&(r.$$scope={dirty:t,ctx:e}),o.$set(r),388&t){let o;for(f=e[7],o=0;o<f.length;o+=1){const r=ct(e,f,o);d[o]?d[o].p(r,t):(d[o]=mt(r),d[o].c(),d[o].m(n,null))}for(;o<d.length;o+=1)d[o].d(1);d.length=f.length}v!==(v=p(e))&&(h.d(1),h=v(e),h&&(h.c(),h.m(a,null))),4&t&&P(a,"enabled","publish"===e[2])},i(e){c||(J(o.$$.fragment,e),c=!0)},o(e){K(o.$$.fragment,e),c=!1},d(e){e&&b(t),oe(o),w(d,e),h.d(),l=!1,u()}}}function pt(t){let n;return{c(){n=z("div"),n.innerHTML='<div class="arrow svelte-oktwv0"></div>\n            File',E(n,"class","toggle svelte-oktwv0"),E(n,"slot","toggle")},m(e,t){y(e,n,t)},p:e,d(e){e&&b(n)}}}function vt(e){let t,n,o,r,s,i=e[24]+1+"";return{c(){t=z("div"),n=k("Example "),o=k(i),E(t,"class","action svelte-oktwv0")},m(i,a){y(i,t,a),x(t,n),x(t,o),r||(s=S(t,"click",e[9](e[22])),r=!0)},p(t,n){e=t},d(e){e&&b(t),r=!1,s()}}}function ht(e){let t,n,r,s,i,a,c,l,u,f,d,p,v,h=le,m=[];for(let t=0;t<h.length;t+=1)m[t]=vt(lt(e,h,t));return{c(){t=z("div"),n=k("Load Example\n              "),r=z("div"),s=$(),i=z("div");for(let e=0;e<m.length;e+=1)m[e].c();a=$(),c=z("div"),c.textContent="New",l=$(),u=z("div"),u.textContent="Import",f=$(),d=z("div"),d.textContent="Export",E(r,"class","arrow svelte-oktwv0"),E(i,"class","examples svelte-oktwv0"),E(t,"class","load svelte-oktwv0"),E(c,"class","action svelte-oktwv0"),E(u,"class","action svelte-oktwv0"),E(d,"class","action svelte-oktwv0")},m(o,h){y(o,t,h),x(t,n),x(t,r),x(t,s),x(t,i);for(let e=0;e<m.length;e+=1)m[e].m(i,null);y(o,a,h),y(o,c,h),y(o,l,h),y(o,u,h),y(o,f,h),y(o,d,h),p||(v=[S(c,"click",e[9](le[0])),S(u,"click",e[10]),S(d,"click",e[12])],p=!0)},p(e,t){if(512&t){let n;for(h=le,n=0;n<h.length;n+=1){const o=lt(e,h,n);m[n]?m[n].p(o,t):(m[n]=vt(o),m[n].c(),m[n].m(i,null))}for(;n<m.length;n+=1)m[n].d(1);m.length=h.length}},d(e){e&&b(t),w(m,e),e&&b(a),e&&b(c),e&&b(l),e&&b(u),e&&b(f),e&&b(d),p=!1,o(v)}}}function mt(e){let t,n,o,r,s,i=e[19]+"";return{c(){t=z("div"),n=k(i),o=$(),E(t,"class","view svelte-oktwv0"),P(t,"enabled",e[2]===e[16])},m(i,a){y(i,t,a),x(t,n),x(t,o),r||(s=S(t,"click",e[8](e[16])),r=!0)},p(n,o){e=n,132&o&&P(t,"enabled",e[2]===e[16])},d(e){e&&b(t),r=!1,s()}}}function gt(e){let t;return{c(){t=k("Publish")},m(e,n){y(e,t,n)},d(e){e&&b(t)}}}function xt(e){let t;return{c(){t=k("Update")},m(e,n){y(e,t,n)},d(e){e&&b(t)}}}function yt(e){let t,n,o,r,s,i,a,c,l,u,f;function d(e,t){return"gallery"===e[2]?ft:ut}let p=d(e),v=p(e),h="gallery"!==e[2]&&dt(e);return{c(){t=z("div"),n=z("input"),o=$(),r=z("a"),s=$(),i=z("div"),a=z("div"),v.c(),c=$(),h&&h.c(),E(n,"type","file"),E(n,"accept","application/json"),E(t,"class","helpers svelte-oktwv0"),E(a,"class","menu svelte-oktwv0")},m(d,p){y(d,t,p),x(t,n),e[17](n),x(t,o),x(t,r),e[18](r),y(d,s,p),y(d,i,p),x(i,a),v.m(a,null),x(i,c),h&&h.m(i,null),l=!0,u||(f=S(n,"change",e[11]),u=!0)},p(e,[t]){p===(p=d(e))&&v?v.p(e,t):(v.d(1),v=p(e),v&&(v.c(),v.m(a,null))),"gallery"!==e[2]?h?(h.p(e,t),4&t&&J(h,1)):(h=dt(e),h.c(),J(h,1),h.m(i,null)):h&&(Z(),K(h,1,1,(()=>{h=null})),H())},i(e){l||(J(h),l=!0)},o(e){K(h),l=!1},d(n){n&&b(t),e[17](null),e[18](null),n&&b(s),n&&b(i),v.d(),h&&h.d(),u=!1,f()}}}function bt(e,t,n){let o,r,s,i,a,c,l;f(e,ue,(e=>n(2,o=e))),f(e,ye,(e=>n(5,i=e)));const{id:u,author:d,title:p}=ve;return f(e,u,(e=>n(6,a=e))),f(e,d,(e=>n(4,s=e))),f(e,p,(e=>n(3,r=e))),[c,l,o,r,s,i,a,[{id:"scene",name:"Scene"},{id:"atlas",name:"Atlas"},{id:"rendering",name:"Rendering"}],e=>()=>{g(ue,o=e,o)},e=>()=>{he({scene:e}),g(ue,o="scene",o),location.hash&&(location.hash="/")},()=>c.click(),()=>{const e=c.files[0];if(!e)return;const t=new FileReader;t.addEventListener("load",(()=>{he(JSON.parse(t.result)),g(ue,o="scene",o),n(0,c.value=null,c),location.hash&&(location.hash="/")}),!1),t.readAsText(e)},()=>{const e=new Blob([JSON.stringify({...me(),version:1})],{type:"application/json"});n(1,l.download="scene.json",l),n(1,l.href=URL.createObjectURL(e),l),l.click()},()=>{location.hash="/gallery"},d,p,u,function(e){I[e?"unshift":"push"]((()=>{c=e,n(0,c)}))},function(e){I[e?"unshift":"push"]((()=>{l=e,n(1,l)}))}]}class wt extends se{constructor(e){super(),re(this,e,bt,yt,s,{})}}var zt=1e-6,kt="undefined"!=typeof Float32Array?Float32Array:Array,$t=Math.PI/180;function St(){var e=new kt(16);return kt!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Et(e,t,n,o){var r=t[0],s=t[1],i=t[2],a=t[3],c=r+r,l=s+s,u=i+i,f=r*c,d=r*l,p=r*u,v=s*l,h=s*u,m=i*u,g=a*c,x=a*l,y=a*u,b=o[0],w=o[1],z=o[2];return e[0]=(1-(v+m))*b,e[1]=(d+y)*b,e[2]=(p-x)*b,e[3]=0,e[4]=(d-y)*w,e[5]=(1-(f+m))*w,e[6]=(h+g)*w,e[7]=0,e[8]=(p+x)*z,e[9]=(h-g)*z,e[10]=(1-(f+v))*z,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Tt=function(e,t,n,o,r){var s,i=1/Math.tan(t/2);return e[0]=i/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(s=1/(o-r),e[10]=(r+o)*s,e[14]=2*r*o*s):(e[10]=-1,e[14]=-2*o),e};function Mt(){var e=new kt(3);return kt!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function _t(e,t,n,o){return e[0]=t,e[1]=n,e[2]=o,e}function Ct(){var e=new kt(2);return kt!=Float32Array&&(e[0]=0,e[1]=0),e}function Pt(e,t){var n=new kt(2);return n[0]=e,n[1]=t,n}function At(e,t,n){return e[0]=t,e[1]=n,e}Mt(),function(){var e=Ct()}();var Bt="fn permute4(x: vec4<f32>) -> vec4<f32> { return ((x * 34. + 1.) * x) % vec4<f32>(289.); }\nfn taylorInvSqrt4(r: vec4<f32>) -> vec4<f32> { return 1.79284291400159 - 0.85373472095314 * r; }\n\nfn noise3(p: vec3<f32>) -> f32 {\n  let a = floor(p);\n  var d: vec3<f32> = p - a;\n  d = d * d * (3. - 2. * d);\n\n  let b = a.xxyy + vec4<f32>(0., 1., 0., 1.);\n  let k1 = permute4(b.xyxy);\n  let k2 = permute4(k1.xyxy + b.zzww);\n\n  let c = k2 + a.zzzz;\n  let k3 = permute4(c);\n  let k4 = permute4(c + 1.);\n\n  let o1 = fract(k3 * (1. / 41.));\n  let o2 = fract(k4 * (1. / 41.));\n\n  let o3 = o2 * d.z + o1 * (1. - d.z);\n  let o4 = o3.yw * d.x + o3.xz * (1. - d.x);\n\n  return o4.y * d.y + o4.x * (1. - d.y);\n}\n\nfn simplexNoise3(v: vec3<f32>) -> f32 {\n  let C = vec2<f32>(1. / 6., 1. / 3.);\n  let D = vec4<f32>(0., 0.5, 1., 2.);\n\n  var i: vec3<f32>  = floor(v + dot(v, C.yyy));\n  let x0 = v - i + dot(i, C.xxx);\n\n  let g = step(x0.yzx, x0.xyz);\n  let l = 1.0 - g;\n  let i1 = min(g.xyz, l.zxy);\n  let i2 = max(g.xyz, l.zxy);\n\n  let x1 = x0 - i1 + 1. * C.xxx;\n  let x2 = x0 - i2 + 2. * C.xxx;\n  let x3 = x0 - 1. + 3. * C.xxx;\n\n  i = i % vec3<f32>(289.);\n  let p = permute4(permute4(permute4(\n      i.z + vec4<f32>(0., i1.z, i2.z, 1. )) +\n      i.y + vec4<f32>(0., i1.y, i2.y, 1. )) +\n      i.x + vec4<f32>(0., i1.x, i2.x, 1. ));\n\n  var n_: f32 = 1. / 7.;\n  let ns = n_ * D.wyz - D.xzx;\n\n  let j = p - 49. * floor(p * ns.z * ns.z);\n\n  let x_ = floor(j * ns.z);\n  let y_ = floor(j - 7.0 * x_);\n\n  let x = x_ *ns.x + ns.yyyy;\n  let y = y_ *ns.x + ns.yyyy;\n  let h = 1.0 - abs(x) - abs(y);\n\n  let b0 = vec4<f32>( x.xy, y.xy );\n  let b1 = vec4<f32>( x.zw, y.zw );\n\n  let s0 = floor(b0)*2.0 + 1.0;\n  let s1 = floor(b1)*2.0 + 1.0;\n  let sh = -step(h, vec4<f32>(0.));\n\n  let a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  let a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  var p0: vec3<f32> = vec3<f32>(a0.xy, h.x);\n  var p1: vec3<f32> = vec3<f32>(a0.zw, h.y);\n  var p2: vec3<f32> = vec3<f32>(a1.xy, h.z);\n  var p3: vec3<f32> = vec3<f32>(a1.zw, h.w);\n\n  let norm = taylorInvSqrt4(vec4<f32>(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3)));\n  p0 = p0 * norm.x;\n  p1 = p1 * norm.y;\n  p2 = p2 * norm.z;\n  p3 = p3 * norm.w;\n\n  var m: vec4<f32> = 0.6 - vec4<f32>(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3));\n  m = max(m, vec4<f32>(0.));\n  m = m * m;\n  return 42. * dot(m * m, vec4<f32>(dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3)));\n}\n";class Ut{constructor({device:e,count:t=254,width:n=16,height:o=16}){this.device=e,this.count=t,this.width=n,this.height=o,this.texture=e.createTexture({dimension:"2d",size:[n,o,t],format:"rgba8unorm",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING})}compute(e="\nfn getColorAt(texture : i32, pixel : vec2<i32>) -> vec4<f32> {\n  var h : f32 = f32(texture) / f32(atlas.count);\n  var s : f32 = 0.5;\n  var l : f32 = 0.5;\n  if (pixel.x == 0 || pixel.y == 0 || pixel.x == (atlas.width - 1) || pixel.y == (atlas.height - 1)) {\n    l = min(l * 1.1, 1);\n  }\n  return hsl2Rgba(h, s, l);\n}\n"){if(this.generator===e)return;this.generator=e;const{device:t,count:n,width:o,height:r,texture:s}=this;this.code=(({count:e,width:t,height:n,generator:o})=>`\n@group(0) @binding(0) var texture : texture_storage_2d_array<rgba8unorm, write>;\n\n${Bt}\n\nstruct Atlas {\n  count : i32,\n  width : i32,\n  height : i32,\n  stride : i32,\n  length : i32,\n}\n\nconst atlas : Atlas = Atlas(\n  ${e},\n  ${t},\n  ${n},\n  ${t*n},\n  ${e*t*n},\n);\n\nfn hue2Rgb(p : f32, q : f32, t : f32) -> f32 {\n  var h : f32 = t;\n  if (h < 0) { h += 1; }\n  if (h > 1) { h -= 1; }\n  if (h < 1 / 6.0) { return p + (q - p) * 6 * h; }\n  if (h < 1 / 2.0) { return q; }\n  if (h < 2 / 3.0) { return p + (q - p) * (2.0 / 3.0 - h) * 6; }\n  return p;\n}\n\nfn hsl2Rgba(h : f32, s: f32, l: f32) -> vec4<f32> {\n  var rgba : vec4<f32> = vec4<f32>(0, 0, 0, 1);\n  if (s == 0) {\n    rgba.r = l;\n    rgba.g = l;\n    rgba.b = l;\n  } else {\n    var q : f32;\n    if (l < 0.5) {\n      q = l * (1 + s);\n    } else {\n      q = l + s - l * s;\n    }\n    var p : f32 = 2 * l - q;\n    rgba.r = hue2Rgb(p, q, h + 1 / 3.0);\n    rgba.g = hue2Rgb(p, q, h);\n    rgba.b = hue2Rgb(p, q, h - 1 / 3.0);\n  }\n  return rgba;\n};\n\n${o}\n\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\n  var id : i32 = i32(GlobalInvocationID.x);\n  if (id >= atlas.length) {\n    return;\n  }\n  var tex : i32 = id / atlas.stride;\n  var index : i32 = id - tex * atlas.stride;\n  var y : i32 = index / atlas.width;\n  var pixel : vec2<i32> = vec2<i32>(index - y * atlas.width, y);\n  textureStore(texture, pixel, tex, getColorAt(tex, pixel));\n}\n`)({count:n,width:o,height:r,generator:e}),this.shader=t.createShaderModule({code:this.code});const i=t.createComputePipeline({layout:"auto",compute:{module:this.shader,entryPoint:"main"}}),a=t.createCommandEncoder(),c=a.beginComputePass();c.setPipeline(i),c.setBindGroup(0,t.createBindGroup({layout:i.getBindGroupLayout(0),entries:[{binding:0,resource:s.createView()}]})),c.dispatchWorkgroups(Math.ceil(n*o*r/64)),c.end(),t.queue.submit([a.finish()])}}const It=St(),Lt=Mt(),Rt=function(e,t,n){var o=new kt(3);return o[0]=e,o[1]=t,o[2]=n,o}(0,1,0);class Nt{constructor({device:e,aspect:t=1,fov:n=75,near:o=.1,far:r=1e3}){this.device=e,this.buffer=e.createBuffer({size:41*Float32Array.BYTES_PER_ELEMENT+12,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.aspect=t,this.fov=n,this.near=o,this.far=r,this.position=Mt(),this.target=Mt(),this.projectionMatrix=St(),this.viewBuffer=new Float32Array(25),this.viewMatrix=this.viewBuffer.subarray(0,16),this.normalMatrix=this.viewBuffer.subarray(16,25)}setOrbit(e,t,n){const{position:o,target:r}=this,s=Math.sin(e)*n;(function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2]})(o,r,_t(Lt,s*Math.sin(t),Math.cos(e)*n,s*Math.cos(t))),this.updateView()}updateProjection(){const{device:e,buffer:t,projectionMatrix:n,aspect:o,fov:r,near:s,far:i}=this;Tt(n,function(e){return e*$t}(r),o,s,i),e.queue.writeBuffer(t,0,n)}updateView(){const{device:e,buffer:t,viewBuffer:n,viewMatrix:o,normalMatrix:r,position:s,target:i}=this;var a,c,l,u,f,d,p,v,h,m,g,x,y,b,w,z,k,$,S,E,T,M,_;a=o,l=i,u=Rt,w=(c=s)[0],z=c[1],k=c[2],$=u[0],S=u[1],E=u[2],T=l[0],M=l[1],_=l[2],Math.abs(w-T)<zt&&Math.abs(z-M)<zt&&Math.abs(k-_)<zt?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(a):(g=w-T,x=z-M,y=k-_,f=S*(y*=b=1/Math.hypot(g,x,y))-E*(x*=b),d=E*(g*=b)-$*y,p=$*x-S*g,(b=Math.hypot(f,d,p))?(f*=b=1/b,d*=b,p*=b):(f=0,d=0,p=0),v=x*p-y*d,h=y*f-g*p,m=g*d-x*f,(b=Math.hypot(v,h,m))?(v*=b=1/b,h*=b,m*=b):(v=0,h=0,m=0),a[0]=f,a[1]=v,a[2]=g,a[3]=0,a[4]=d,a[5]=h,a[6]=x,a[7]=0,a[8]=p,a[9]=m,a[10]=y,a[11]=0,a[12]=-(f*w+d*z+p*k),a[13]=-(v*w+h*z+m*k),a[14]=-(g*w+x*z+y*k),a[15]=1),function(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],u=t[8],f=t[9],d=t[10],p=t[11],v=t[12],h=t[13],m=t[14],g=t[15],x=n*a-o*i,y=n*c-r*i,b=n*l-s*i,w=o*c-r*a,z=o*l-s*a,k=r*l-s*c,$=u*h-f*v,S=u*m-d*v,E=u*g-p*v,T=f*m-d*h,M=f*g-p*h,_=d*g-p*m,C=x*_-y*M+b*T+w*E-z*S+k*$;C&&(C=1/C,e[0]=(a*_-c*M+l*T)*C,e[1]=(c*E-i*_-l*S)*C,e[2]=(i*M-a*E+l*$)*C,e[3]=(r*M-o*_-s*T)*C,e[4]=(n*_-r*E+s*S)*C,e[5]=(o*E-n*M-s*$)*C,e[6]=(h*k-m*z+g*w)*C,e[7]=(m*b-v*k-g*y)*C,e[8]=(v*z-h*b+g*x)*C)}(r,function(e,t){var n=t[0],o=t[1],r=t[2],s=t[3],i=t[4],a=t[5],c=t[6],l=t[7],u=t[8],f=t[9],d=t[10],p=t[11],v=t[12],h=t[13],m=t[14],g=t[15],x=n*a-o*i,y=n*c-r*i,b=n*l-s*i,w=o*c-r*a,z=o*l-s*a,k=r*l-s*c,$=u*h-f*v,S=u*m-d*v,E=u*g-p*v,T=f*m-d*h,M=f*g-p*h,_=d*g-p*m,C=x*_-y*M+b*T+w*E-z*S+k*$;return C?(C=1/C,e[0]=(a*_-c*M+l*T)*C,e[1]=(r*M-o*_-s*T)*C,e[2]=(h*k-m*z+g*w)*C,e[3]=(d*z-f*k-p*w)*C,e[4]=(c*E-i*_-l*S)*C,e[5]=(n*_-r*E+s*S)*C,e[6]=(m*b-v*k-g*y)*C,e[7]=(u*k-d*b+p*y)*C,e[8]=(i*M-a*E+l*$)*C,e[9]=(o*E-n*M-s*$)*C,e[10]=(v*z-h*b+g*x)*C,e[11]=(f*b-u*z-p*x)*C,e[12]=(a*S-i*T-c*$)*C,e[13]=(n*T-o*S+r*$)*C,e[14]=(h*y-v*w-m*x)*C,e[15]=(u*w-f*y+d*x)*C,e):null}(It,o)),e.queue.writeBuffer(t,64,n)}}var Vt="const PI : f32 = 3.141592653589793;\n\nfn rotateX(rad : f32) -> mat3x3<f32> {\n  var c : f32 = cos(rad);\n  var s : f32 = sin(rad);\n  return mat3x3<f32>(\n    1, 0, 0,\n    0, c, s,\n    0, -s, c,\n  );\n}\n\nfn rotateY(rad : f32) -> mat3x3<f32> {\n  var c : f32 = cos(rad);\n  var s : f32 = sin(rad);\n  return mat3x3<f32>(\n    c, 0, -s,\n    0, 1, 0,\n    s, 0, c,\n  );\n}\n\nfn rotateZ(rad : f32) -> mat3x3<f32> {\n  var c : f32 = cos(rad);\n  var s : f32 = sin(rad);\n  return mat3x3<f32>(\n    c, s, 0,\n    -s, c, 0,\n    0, 0, 1,\n  );\n}\n";class Gt{constructor({device:e,format:t}){this.device=e,this.descriptor={colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]},this.effects=(e=>{const t=new Float32Array([0,0,0,.3,.5,.5]),n=e.createBuffer({size:32,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,mappedAtCreation:!0});return new Float32Array(n.getMappedRange()).set(t),n.unmap(),{buffer:n,edges:{get color(){return t.subarray(0,3)},set color(o){t.set(o),e.queue.writeBuffer(n,0,t,0,3)},get intensity(){return t[3]},set intensity(o){t[3]=o,e.queue.writeBuffer(n,12,t,3,1)},get depthScale(){return t[4]},set depthScale(o){t[4]=o,e.queue.writeBuffer(n,16,t,4,1)},get normalScale(){return t[5]},set normalScale(o){t[5]=o,e.queue.writeBuffer(n,20,t,5,1)}}}})(e),this.geometry=(e=>{const t=e.createBuffer({size:18*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});return new Float32Array(t.getMappedRange()).set([-1,-1,1,1,-1,1,1,1,1,1,1,1,-1,1,1,-1,-1,1]),t.unmap(),t})(e),this.pipeline=e.createRenderPipeline({layout:"auto",vertex:{module:e.createShaderModule({code:"\n@vertex\nfn main(@location(0) position : vec4<f32>) -> @builtin(position) vec4<f32> {\n  return position;\n}\n"}),entryPoint:"main",buffers:[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]}]},fragment:{module:e.createShaderModule({code:"\nstruct Edges {\n  color : vec3<f32>,\n  intensity : f32,\n  depthScale : f32,\n  normalScale : f32,\n}\n\nstruct Effects {\n  edges : Edges,\n}\n\n@group(0) @binding(0) var<uniform> effects : Effects;\n@group(0) @binding(1) var colorTexture : texture_2d<f32>;\n@group(0) @binding(2) var normalTexture : texture_2d<f32>;\n@group(0) @binding(3) var positionTexture : texture_2d<f32>;\n\nconst offset : vec3<i32> = vec3<i32>(1, 1, 0);\n\nfn edgesDepth(pixel : vec2<i32>) -> f32 {\n  var pixelCenter : f32 = textureLoad(positionTexture, pixel, 0).z;\n  var pixelLeft : f32 = textureLoad(positionTexture, pixel - offset.xz, 0).z;\n  var pixelRight : f32 = textureLoad(positionTexture, pixel + offset.xz, 0).z;\n  var pixelUp : f32 = textureLoad(positionTexture, pixel + offset.zy, 0).z;\n  var pixelDown : f32 = textureLoad(positionTexture, pixel - offset.zy, 0).z;\n  return (\n    abs(pixelLeft    - pixelCenter) \n    + abs(pixelRight - pixelCenter) \n    + abs(pixelUp    - pixelCenter) \n    + abs(pixelDown  - pixelCenter) \n  ) * effects.edges.depthScale;\n}\n\nfn edgesNormal(pixel : vec2<i32>) -> f32 {\n  var pixelCenter : vec3<f32> = textureLoad(normalTexture, pixel, 0).xyz;\n  var pixelLeft : vec3<f32> = textureLoad(normalTexture, pixel - offset.xz, 0).xyz;\n  var pixelRight : vec3<f32> = textureLoad(normalTexture, pixel + offset.xz, 0).xyz;\n  var pixelUp : vec3<f32> = textureLoad(normalTexture, pixel + offset.zy, 0).xyz;\n  var pixelDown : vec3<f32> = textureLoad(normalTexture, pixel - offset.zy, 0).xyz;\n  var edge : vec3<f32> = (\n    abs(pixelLeft    - pixelCenter)\n    + abs(pixelRight - pixelCenter) \n    + abs(pixelUp    - pixelCenter) \n    + abs(pixelDown  - pixelCenter)\n  );\n  return (edge.x + edge.y + edge.z) * effects.edges.normalScale;\n}\n\n@fragment\nfn main(@builtin(position) uv : vec4<f32>) -> @location(0) vec4<f32> {\n  var pixel : vec2<i32> = vec2<i32>(floor(uv.xy));\n  var color : vec3<f32> = textureLoad(colorTexture, pixel, 0).xyz;\n  if (effects.edges.intensity != 0) {\n    color = mix(color, effects.edges.color, clamp(max(edgesDepth(pixel), edgesNormal(pixel)), 0, 1) * effects.edges.intensity);\n  }\n  return vec4<f32>(color, 1);\n}\n"}),entryPoint:"main",targets:[{format:t}]},primitive:{topology:"triangle-list"}})}bindTextures({color:e,normal:t,position:n}){const{device:o,effects:r,pipeline:s}=this;this.bindings=o.createBindGroup({layout:s.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:r.buffer}},{binding:1,resource:e},{binding:2,resource:t},{binding:3,resource:n}]})}render(e,t){const{bindings:n,descriptor:o,geometry:r,pipeline:s}=this;o.colorAttachments[0].view=t;const i=e.beginRenderPass(o);i.setPipeline(s),i.setBindGroup(0,n),i.setVertexBuffer(0,r),i.draw(6,1,0,0),i.end()}}const Ot=`\nstruct VertexInput {\n  @location(0) position : vec3<f32>,\n  @location(1) uv : vec2<f32>,\n  @location(2) face : vec4<f32>,\n}\n\nstruct VertexOutput {\n  @builtin(position) position : vec4<f32>,\n  @location(0) viewPosition: vec3<f32>,\n  @location(1) normal: vec3<f32>,\n  @location(2) uv: vec2<f32>,\n  @location(3) @interpolate(flat) texture: i32,\n}\n\nstruct Camera {\n  projection : mat4x4<f32>,\n  view : mat4x4<f32>,\n  normal : mat3x3<f32>,\n}\n\n@group(0) @binding(0) var<uniform> camera : Camera;\n\n${Vt}\n\nconst faceNormal : vec3<f32> = vec3<f32>(0, 0, 1);\n\n@vertex\nfn main(voxel : VertexInput) -> VertexOutput {\n  var rotation : mat3x3<f32>;\n  switch (i32(voxel.face.w % 6)) {\n    default {\n      rotation = mat3x3<f32>(\n        1, 0, 0,\n        0, 1, 0,\n        0, 0, 1,\n      );\n    }\n    case 1 {\n      rotation = rotateX(PI * -0.5);\n    }\n    case 2 {\n      rotation = rotateX(PI * 0.5);\n    }\n    case 3 {\n      rotation = rotateY(PI * -0.5);\n    }\n    case 4 {\n      rotation = rotateY(PI * 0.5);\n    }\n    case 5 {\n      rotation = rotateY(PI);\n    }\n  }\n  var mvPosition : vec4<f32> = camera.view * vec4<f32>(rotation * voxel.position + voxel.face.xyz, 1);\n  var out : VertexOutput;\n  out.position = camera.projection * mvPosition;\n  out.viewPosition = -mvPosition.xyz;\n  out.normal = normalize(camera.normal * rotation * faceNormal);\n  out.uv = voxel.uv;\n  out.texture = i32(floor(voxel.face.w / 6));\n  return out;\n}\n`,Ft=e=>{const t=e.createBuffer({size:30*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX,mappedAtCreation:!0});return new Float32Array(t.getMappedRange()).set([-.5,-.5,.5,0,1,.5,-.5,.5,1,1,.5,.5,.5,1,0,.5,.5,.5,1,0,-.5,.5,.5,0,0,-.5,-.5,.5,0,1]),t.unmap(),t};class qt{constructor({adapter:e,device:t,atlas:n=null,camera:o=null,canvas:r=null,samples:s=4}){const i=navigator.gpu.getPreferredCanvasFormat(e);this.atlas=n||new Ut({device:t}),this.camera=o||new Nt({device:t}),this.canvas=r||document.createElement("canvas"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.context=this.canvas.getContext("webgpu"),this.context.configure({alphaMode:"opaque",device:t,format:i}),this.device=t,this.samples=s;const a=t.createRenderPipeline({layout:"auto",vertex:{module:t.createShaderModule({code:Ot}),entryPoint:"main",buffers:[{arrayStride:5*Float32Array.BYTES_PER_ELEMENT,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:3*Float32Array.BYTES_PER_ELEMENT,format:"float32x2"}]},{arrayStride:4*Float32Array.BYTES_PER_ELEMENT,stepMode:"instance",attributes:[{shaderLocation:2,offset:0,format:"float32x4"}]}]},fragment:{module:t.createShaderModule({code:"\nstruct FragmentInput {\n  @location(0) position : vec3<f32>,\n  @location(1) normal : vec3<f32>,\n  @location(2) uv : vec2<f32>,\n  @location(3) @interpolate(flat) texture : i32,\n}\n\nstruct FragmentOutput {\n  @location(0) color : vec4<f32>,\n  @location(1) normal : vec4<f32>,\n  @location(2) position : vec4<f32>,\n}\n\n@group(0) @binding(1) var atlas : texture_2d_array<f32>;\n@group(0) @binding(2) var atlasSampler : sampler;\n\n@fragment\nfn main(face : FragmentInput) -> FragmentOutput {\n  var output : FragmentOutput;\n  output.color = textureSample(atlas, atlasSampler, face.uv, face.texture);\n  output.normal = vec4<f32>(normalize(face.normal), 1);\n  output.position = vec4<f32>(face.position, 1);\n  return output;\n}\n"}),entryPoint:"main",targets:[{format:"rgba8unorm"},{format:"rgba16float"},{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},multisample:{count:this.samples}});this.rendering={bindings:t.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.camera.buffer}},{binding:1,resource:this.atlas.texture.createView()},{binding:2,resource:t.createSampler()}]}),descriptor:{colorAttachments:[{clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"},{clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},geometry:Ft(t),pipeline:a},this.postprocessing=new Gt({device:t,format:i})}render(e,t){const{context:n,postprocessing:o,rendering:{bindings:r,descriptor:s,geometry:i,pipeline:a}}=this,c=e.beginRenderPass(s);c.setPipeline(a),c.setBindGroup(0,r),c.setVertexBuffer(0,i),t.chunks.forEach((({faces:e})=>{c.setVertexBuffer(1,e,16),c.drawIndirect(e,0)})),c.end(),o.render(e,n.getCurrentTexture().createView())}setClearColor(e,t,n){const{rendering:{descriptor:{colorAttachments:[{clearValue:o}]}}}=this;o.r=e,o.g=t,o.b=n}setSize(e,t){const{camera:n,canvas:o,device:r,postprocessing:s,rendering:i,samples:a}=this,c=window.devicePixelRatio||1,l=[Math.floor(e*c),Math.floor(t*c)];o.width=l[0],o.height=l[1],o.style.width=`${e}px`,o.style.height=`${t}px`,n.aspect=e/t,n.updateProjection();const u=(e,t,n,o)=>(e[t]&&e[t].destroy(),e[t]=r.createTexture({size:l,sampleCount:n,format:o,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),e[t].createView());i.descriptor.colorAttachments[0].view=u(i,"colorTexture",a,"rgba8unorm"),i.descriptor.colorAttachments[0].resolveTarget=u(i,"colorTarget",1,"rgba8unorm"),i.descriptor.colorAttachments[1].view=u(i,"normalTexture",a,"rgba16float"),i.descriptor.colorAttachments[1].resolveTarget=u(i,"normalTarget",1,"rgba16float"),i.descriptor.colorAttachments[2].view=u(i,"positionTexture",a,"rgba16float"),i.descriptor.colorAttachments[2].resolveTarget=u(i,"positionTarget",1,"rgba16float"),i.descriptor.depthStencilAttachment.view=u(i,"depthTexture",a,"depth24plus"),s.bindTextures({color:i.colorTarget.createView(),normal:i.normalTarget.createView(),position:i.positionTarget.createView()})}}var Dt=({chunkSize:e})=>`\nconst chunkSize : i32 = ${e};\n\nfn getVoxel(pos : vec3<i32>) -> u32 {\n  return u32(pos.z * chunkSize * chunkSize + pos.y * chunkSize + pos.x);\n}\n`;const jt=({chunkSize:e})=>`\nstruct Faces {\n  vertexCount : u32,\n  instanceCount : atomic<u32>,\n  firstVertex : u32,\n  firstInstance : u32,\n  data : array<f32>,\n}\n\n@group(0) @binding(0) var<uniform> chunk : vec3<i32>;\n@group(0) @binding(1) var<storage, read_write> faces : Faces;\n@group(0) @binding(2) var<storage, read> voxels : array<f32>;\n@group(0) @binding(3) var<storage, read> voxels_north : array<f32>;\n@group(0) @binding(4) var<storage, read> voxels_top : array<f32>;\n@group(0) @binding(5) var<storage, read> voxels_bottom : array<f32>;\n@group(0) @binding(6) var<storage, read> voxels_west : array<f32>;\n@group(0) @binding(7) var<storage, read> voxels_east : array<f32>;\n@group(0) @binding(8) var<storage, read> voxels_south : array<f32>;\n\n${Dt({chunkSize:e})}\n\nfn isAir(pos : vec3<i32>) -> bool {\n  if (pos.x == -1) {\n    return voxels_west[getVoxel(vec3<i32>(chunkSize - 1, pos.y, pos.z))] == 0;\n  }\n  if (pos.x == chunkSize) {\n    return voxels_east[getVoxel(vec3<i32>(0, pos.y, pos.z))] == 0.0;\n  }\n  if (pos.y == -1) {\n    return voxels_bottom[getVoxel(vec3<i32>(pos.x, chunkSize - 1, pos.z))] == 0;\n  }\n  if (pos.y == chunkSize) {\n    return voxels_top[getVoxel(vec3<i32>(pos.x, 0, pos.z))] == 0;\n  }\n  if (pos.z == -1) {\n    return voxels_south[getVoxel(vec3<i32>(pos.x, pos.y, chunkSize - 1))] == 0;\n  }\n  if (pos.z == chunkSize) {\n    return voxels_north[getVoxel(vec3<i32>(pos.x, pos.y, 0))] == 0;\n  }\n  return voxels[getVoxel(pos)] == 0; \n}\n\nfn pushFace(pos : vec3<i32>, face : i32, texture : i32) {\n  var offset : u32 = atomicAdd(&(faces.instanceCount), 1) * 4;\n  faces.data[offset] = f32(pos.x) + 0.5;\n  faces.data[offset + 1] = f32(pos.y) + 0.5;\n  faces.data[offset + 2] = f32(pos.z) + 0.5;\n  faces.data[offset + 3] = f32(texture * 6 + face);\n}\n\nconst faceNormals = array<vec3<i32>, 6>(\n  vec3<i32>(0, 0, 1),\n  vec3<i32>(0, 1, 0),\n  vec3<i32>(0, -1, 0),\n  vec3<i32>(-1, 0, 0),\n  vec3<i32>(1, 0, 0),\n  vec3<i32>(0, 0, -1),\n);\n\n@compute @workgroup_size(4, 4, 4)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\n  var pos : vec3<i32> = vec3<i32>(GlobalInvocationID.xyz);\n  if (\n    pos.x >= chunkSize || pos.y >= chunkSize || pos.z >= chunkSize\n  ) {\n    return;\n  }\n  var value : f32 = voxels[getVoxel(pos)];\n  if (value != 0) {\n    var texture : i32 = i32(floor(value) - 1);\n    for (var face : i32 = 0; face < 6; face++) {\n      var npos : vec3<i32> = pos + faceNormals[face];\n      if (isAir(npos)) {\n        pushFace(chunk + pos, face, texture);\n      }\n    }\n  }\n}\n`;class Yt{constructor({chunks:e,volume:t}){this.pipeline=t.device.createComputePipeline({layout:"auto",compute:{module:t.device.createShaderModule({code:jt({chunkSize:t.chunkSize})}),entryPoint:"main"}});const n={x:0,y:0,z:0},o=(o,r)=>{if(n.x=o.x+r.x,n.y=o.y+r.y,n.z=o.z+r.z,n.x<0||n.x>=e.x||n.y<0||n.y>=e.y||n.z<0||n.z>=e.z)return t.edge;const s=n.z*e.x*e.y+n.y*e.x+n.x;return t.chunks[s].voxels},r=[{x:0,y:0,z:1},{x:0,y:1,z:0},{x:0,y:-1,z:0},{x:-1,y:0,z:0},{x:1,y:0,z:0},{x:0,y:0,z:-1}];this.bindings=t.chunks.map((e=>({bindings:t.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[e.position,e.faces,e.voxels,...r.map((t=>o(e.chunk,t)))].map(((e,t)=>({binding:t,resource:{buffer:e}})))}),chunk:e}))),this.workgroups=Math.ceil(t.chunkSize/4)}compute(e){const{bindings:t,pipeline:n,workgroups:o}=this;t.forEach((({bindings:t,chunk:r})=>{r.resetInstanceCount(e);const s=e.beginComputePass();s.setPipeline(n),s.setBindGroup(0,t),s.dispatchWorkgroups(o,o,o),s.end()}))}}class Xt{constructor({device:e,position:t=new Float32Array([0,0,0]),rotation:n=new Float32Array([0,0,0,1]),scale:o=new Float32Array([1,1,1])}){this.device=e,this.data=St(),this.buffer=e.createBuffer({mappedAtCreation:!0,size:this.data.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),Et(this.data,n,t,o),new Float32Array(this.buffer.getMappedRange()).set(this.data),this.buffer.unmap()}destroy(){const{buffer:e}=this;e.destroy()}set(e,t,n){const{device:o,buffer:r,data:s}=this;Et(s,t,e,n),o.queue.writeBuffer(r,0,s)}}class Wt{constructor({geometry:e,volume:t}){const n=e.indices.length/3;this.code=(({chunkSize:e,source:t,triangles:n})=>`\n@group(0) @binding(0) var<uniform> chunk : vec3<i32>;\n@group(0) @binding(1) var<uniform> transform : mat4x4<f32>;\n@group(0) @binding(2) var<storage, read> indices : array<array<u32, 3>>;\n@group(0) @binding(3) var<storage, read> vertices : array<array<f32, 3>>;\n@group(0) @binding(4) var<storage, read_write> voxels : array<f32>;\n\n${Dt({chunkSize:e})}\n\nstruct AxisTest {\n  ann : vec3<f32>,\n  fnn : vec3<f32>,\n  aa : i32,\n  bb : i32,\n}\n\nfn intersects(triangle : array<vec3<f32>, 3>, voxel : vec3<f32>) -> bool {\n  var v0 : vec3<f32> = triangle[0] - voxel;\n  var v1 : vec3<f32> = triangle[1] - voxel;\n  var v2 : vec3<f32> = triangle[2] - voxel;\n\n  var f0 : vec3<f32> = v1 - v0;\n  var f1 : vec3<f32> = v2 - v1;\n  var f2 : vec3<f32> = v0 - v2;\n\n  var axis_test = array<AxisTest, 9>(\n    AxisTest(vec3<f32>(0, -f0.z, f0.y), f0, 1, 2),\n    AxisTest(vec3<f32>(0, -f1.z, f1.y), f1, 1, 2),\n    AxisTest(vec3<f32>(0, -f2.z, f2.y), f2, 1, 2),\n    AxisTest(vec3<f32>(f0.z, 0, -f0.x), f0, 0, 2),\n    AxisTest(vec3<f32>(f1.z, 0, -f1.x), f1, 0, 2),\n    AxisTest(vec3<f32>(f2.z, 0, -f2.x), f2, 0, 2),\n    AxisTest(vec3<f32>(-f0.y, f0.x, 0), f0, 0, 1),\n    AxisTest(vec3<f32>(-f1.y, f1.x, 0), f1, 0, 1),\n    AxisTest(vec3<f32>(-f2.y, f2.x, 0), f2, 0, 1),\n  );\n\n  for (var i : i32 = 0; i < 9; i++) {\n    var t : AxisTest = axis_test[i];\n    var p0 : f32 = dot(v0, t.ann);\n    var p1 : f32 = dot(v1, t.ann);\n    var p2 : f32 = dot(v2, t.ann);\n    var r : f32 = 0.5 * abs(t.fnn[t.bb]) + 0.5 * abs(t.fnn[t.aa]);\n    if (max(-max(p0, max(p1, p2)), min(p0, min(p1, p2))) > r) {\n      return false;\n    }\n  }\n\n  if (max(v0.x, max(v1.x, v2.x)) < -0.5 || min(v0.x, min(v1.x, v2.x)) > 0.5) {\n    return false;\n  }\n  if (max(v0.y, max(v1.y, v2.y)) < -0.5 || min(v0.y, min(v1.y, v2.y)) > 0.5) {\n    return false;\n  }\n  if (max(v0.z, max(v1.z, v2.z)) < -0.5 || min(v0.z, min(v1.z, v2.z)) > 0.5) {\n    return false;\n  }\n\n  var planeNorm : vec3<f32> = normalize(cross(f1, f0));\n  var planeConst : f32 = dot(planeNorm, triangle[0]);\n  var r : f32 = 0.5 * abs(planeNorm.x) + 0.5 * abs(planeNorm.y) + 0.5 * abs(planeNorm.z);\n  var s : f32 = abs(dot(planeNorm, voxel) - planeConst);\n  return s <= r;\n}\n\nfn getVertex(index : u32) -> vec3<f32> {\n  var vertex : vec4<f32> = vec4<f32>(vertices[index][0], vertices[index][1], vertices[index][2], 1);\n  return (transform * vertex).xyz - vec3<f32>(chunk);\n}\n\nconst triangles : u32 = ${n};\n\n${t}\n\n@compute @workgroup_size(64)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\n  var id : u32 = GlobalInvocationID.x;\n  if (id >= triangles) {\n    return;\n  }\n\n  var triangle = array<vec3<f32>, 3>(\n    getVertex(indices[id][0]),\n    getVertex(indices[id][1]),\n    getVertex(indices[id][2]),\n  );\n\n  var tmin : vec3<i32> = vec3<i32>(chunkSize);\n  var tmax : vec3<i32> = vec3<i32>(0);\n  for (var i : i32 = 0; i < 3; i++) {\n    var p = vec3<i32>(triangle[i]);\n    tmin = min(tmin, p);\n    tmax = max(tmax, p);\n  }\n  tmin = clamp(tmin, vec3<i32>(0), vec3<i32>(chunkSize - 1));\n  tmax = clamp(tmax, vec3<i32>(0), vec3<i32>(chunkSize - 1));\n\n  for (var z : i32 = tmin.z; z <= tmax.z; z++) {\n    for (var y : i32 = tmin.y; y <= tmax.y; y++) {\n      for (var x : i32 = tmin.x; x <= tmax.x; x++) {\n        if (intersects(triangle, vec3<f32>(f32(x) + 0.5, f32(y) + 0.5, f32(z) + 0.5))) {\n          var pos : vec3<i32> = vec3<i32>(x, y, z);\n          voxels[getVoxel(pos)] = getValueAt(vec3<f32>(chunk + pos));\n        }\n      }\n    }\n  }\n}\n`)({chunkSize:t.chunkSize,source:e.source||"\nfn getValueAt(pos : vec3<f32>) -> f32 {\n  return 1;\n}\n",triangles:n}),this.shader=t.device.createShaderModule({code:this.code}),this.pipeline=t.device.createComputePipeline({layout:"auto",compute:{module:this.shader,entryPoint:"main"}}),this.transform=new Xt({device:t.device,position:e.position,rotation:e.rotation,scale:e.scale}),this.indices=t.device.createBuffer({mappedAtCreation:!0,size:e.indices.byteLength,usage:GPUBufferUsage.STORAGE}),new Uint32Array(this.indices.getMappedRange()).set(e.indices),this.indices.unmap(),this.vertices=t.device.createBuffer({mappedAtCreation:!0,size:e.vertices.byteLength,usage:GPUBufferUsage.STORAGE}),new Float32Array(this.vertices.getMappedRange()).set(e.vertices),this.vertices.unmap(),this.bindings=t.chunks.map((({position:e,voxels:n})=>({bindings:t.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[e,this.transform.buffer,this.indices,this.vertices,n].map(((e,t)=>({binding:t,resource:{buffer:e}})))}),clearChunk:e=>e.clearBuffer(n)}))),this.workgroups=Math.ceil(n/64)}compute(e){const{bindings:t,pipeline:n,workgroups:o}=this;t.forEach((({bindings:t,clearChunk:r})=>{r(e);const s=e.beginComputePass();s.setPipeline(n),s.setBindGroup(0,t),s.dispatchWorkgroups(o),s.end()}))}destroy(){const{transform:e,indices:t,vertices:n}=this;e.destroy(),t.destroy(),n.destroy()}}class Zt{constructor({source:e,volume:t}){this.code=(({chunkSize:e,width:t,height:n,depth:o,source:r})=>`\n@group(0) @binding(0) var<uniform> time : f32;\n@group(0) @binding(1) var<uniform> chunk : vec3<i32>;\n@group(0) @binding(2) var<storage, read_write> voxels : array<f32>;\n\n${Bt}\n${Vt}\nfn sdBox(p : vec3<f32>, r : vec3<f32>) -> f32 {\n  var q : vec3<f32> = abs(p) - r;\n  return length(max(q, vec3<f32>(0))) + min(max(q.x, max(q.y, q.z)), 0);\n}\n\nfn sdCapsule(p : vec3<f32>, r : vec3<f32>) -> f32 {\n  var q : vec3<f32> = vec3<f32>(p.x, clamp(p.y, -r.y + r.x, r.y - r.x), p.y);\n  return length(q) - q.x;\n}\n\nfn sdEllipsoid(p : vec3<f32>, r : vec3<f32>) -> f32 {\n  var k0 : f32 = length(p / r);\n  var k1 : f32 = length(p / (r * r));\n  return k0 * (k0 - 1.0) / k1;\n}\n\nfn sdSphere(p : vec3<f32>, r : f32) -> f32 {\n  return length(p) - r;\n}\n\nfn sdTorus(p : vec3<f32>, r : vec2<f32>) -> f32 {\n  var q : vec2<f32> = vec2<f32>(length(p.xz) - r.x, p.y);\n  return length(q) - r.y;\n}\n\nfn opUnion(d1 : f32, d2 : f32) -> f32 {\n  return min(d1, d2);\n}\n\nfn opSubstraction(d1 : f32, d2 : f32) -> f32 {\n  return max(d1, -d2);\n}\n\nfn opSmoothUnion(d1 : f32, d2 : f32, k : f32) -> f32 {\n  var h : f32 = clamp(0.5 + 0.5 * (d2 - d1) / k, 0, 1);\n  return mix(d2, d1, h) + k * h * (1 - h);\n}\n\nfn opSmoothSubstraction(d1 : f32, d2 : f32, k : f32) -> f32 {\n  var h : f32 = clamp(0.5 - 0.5 * (d2 + d1) / k, 0, 1);\n  return mix(d1, -d2, h) + k * h * (1 - h);\n}\n\n${Dt({chunkSize:e})}\n\nstruct Volume {\n  center : vec3<f32>,\n  size : vec3<f32>,\n}\n\nconst volume : Volume = Volume(\n  vec3<f32>(${.5*t}, ${.5*n}, ${.5*o}),\n  vec3<f32>(${t}, ${n}, ${o})\n);\n\n${r}\n\n@compute @workgroup_size(4, 4, 4)\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\n  var pos : vec3<i32> = vec3<i32>(GlobalInvocationID.xyz);\n  if (\n    pos.x >= chunkSize || pos.y >= chunkSize || pos.z >= chunkSize\n  ) {\n    return;\n  }\n  voxels[getVoxel(pos)] = getValueAt(vec3<f32>(chunk + pos));\n}\n`)({chunkSize:t.chunkSize,width:t.width,height:t.height,depth:t.depth,source:e}),this.shader=t.device.createShaderModule({code:this.code}),this.pipeline=t.device.createComputePipeline({layout:"auto",compute:{module:this.shader,entryPoint:"main"}}),this.bindings=t.chunks.map((({position:e,voxels:n})=>t.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[t.time.buffer,e,n].map(((e,t)=>({binding:t,resource:{buffer:e}})))}))),this.workgroups=Math.ceil(t.chunkSize/4)}compute(e){const{bindings:t,pipeline:n,workgroups:o}=this;t.forEach((t=>{const r=e.beginComputePass();r.setPipeline(n),r.setBindGroup(0,t),r.dispatchWorkgroups(o,o,o),r.end()}))}}class Ht{constructor({device:e,chunk:t,chunkSize:n}){this.chunk=t,this.faces=e.createBuffer({mappedAtCreation:!0,size:4*Uint32Array.BYTES_PER_ELEMENT+6*Math.ceil(n*n*n*.5)*4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.INDIRECT|GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX}),new Uint32Array(this.faces.getMappedRange())[0]=6,this.faces.unmap(),this.position=e.createBuffer({mappedAtCreation:!0,size:3*Int32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM}),new Int32Array(this.position.getMappedRange()).set([t.x*n,t.y*n,t.z*n]),this.position.unmap(),this.voxels=Ht.createVoxelsBuffer({device:e,chunkSize:n})}destroy(){const{faces:e,position:t,voxels:n}=this;e.destroy(),t.destroy(),n.destroy()}resetInstanceCount(e){const{faces:t}=this;e.clearBuffer(t,4,4)}static createVoxelsBuffer({device:e,chunkSize:t}){return e.createBuffer({size:t*t*t*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE})}}class Jt{constructor({device:e}){this.device=e,this.data=new Float32Array(1),this.buffer=e.createBuffer({size:this.data.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM})}destroy(){const{buffer:e}=this;e.destroy()}set(e){const{device:t,buffer:n,data:o}=this;o[0]=e,t.queue.writeBuffer(n,0,o)}}class Kt{constructor({chunkSize:e=100,device:t,width:n,height:o,depth:r}){this.chunkSize=e,this.device=t,this.width=n,this.height=o,this.depth=r;const s={x:Math.ceil(n/e),y:Math.ceil(o/e),z:Math.ceil(r/e)};this.chunks=[];for(let n=0;n<s.z;n++)for(let o=0;o<s.y;o++)for(let r=0;r<s.x;r++)this.chunks.push(new Ht({device:t,chunk:{x:r,y:o,z:n},chunkSize:e}));this.edge=Ht.createVoxelsBuffer({device:t,chunkSize:e}),this.mesher=new Yt({chunks:s,volume:this}),this.time=new Jt({device:t})}compute(e,t){const{mesher:n,time:o,voxelizer:r}=this;o.set(t),r.compute(e),n.compute(e)}destroy(){const{chunks:e,edge:t,time:n,voxelizer:o}=this;e.forEach((e=>e.destroy())),t.destroy(),n.destroy(),o&&o.destroy&&o.destroy()}setScene(e){const{voxelizer:t}=this;t&&t.destroy&&t.destroy(),e.geometry?this.voxelizer=new Wt({geometry:e.geometry,volume:this}):e.source&&(this.voxelizer=new Zt({source:e.source,volume:this}))}}class Qt{constructor(e){this.look={state:Pt(.5*Math.PI,0),target:Pt(.5*Math.PI,0)},this.pointer={movement:Ct(),position:Ct()},this.zoom={state:.75,target:.75},this.target=e,this.updateBounds(),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),e.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("mouseup",this.onMouseUp,!1),window.addEventListener("wheel",this.onMouseWheel,{passive:!1})}destroy(){this.target.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("wheel",this.onMouseWheel)}onMouseDown({button:e}){const{pointer:t}=this;t.isDown=0===e}onMouseMove({clientX:e,clientY:t,movementX:n,movementY:o}){const{sensitivity:r}=Qt,{bounds:s,pointer:{movement:i,position:a}}=this;i[0]-=n*r.look,i[1]-=o*r.look,At(a,(e-s.x)/s.width*2-1,-(t-s.y)/s.height*2+1)}onMouseUp({button:e}){const{pointer:t}=this;0===e&&(t.isDown=!1)}onMouseWheel(e){e.ctrlKey&&e.preventDefault();const{sensitivity:t,minZoom:n,zoomRange:o}=Qt,{zoom:r}=this,s=Math.min(Math.max((Math.log(r.target)-n)/o+e.deltaY*t.zoom,0),1);r.target=Math.exp(n+s*o)}update(e){const{minPhi:t,maxPhi:n}=Qt,{pointer:o,look:r,zoom:s}=this;o.isDown&&(r.target[1]+=o.movement[0],r.target[0]=Math.min(Math.max(r.target[0]+o.movement[1],t),n));const i=1-Math.exp(-10*e);!function(e,t,n,o){var r=t[0],s=t[1];e[0]=r+o*(n[0]-r),e[1]=s+o*(n[1]-s)}(r.state,r.state,r.target,i),s.state=s.state*(1-i)+s.target*i,At(o.movement,0,0)}updateBounds(){const{target:e}=this;this.bounds=e.getBoundingClientRect()}}function en(t){let n;return{c(){n=z("div"),E(n,"class","viewport svelte-vo8in0")},m(e,o){y(e,n,o),t[1](n)},p:e,i:e,o:e,d(e){e&&b(n),t[1](null)}}}function tn(e,t,n){const o=e=>[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255];let r;return B((()=>{const e=new Qt(r),t=new qt(de.gpu);r.appendChild(t.canvas),t.setSize(window.innerWidth,window.innerHeight),t.setSize(e.bounds.width,e.bounds.height),window.addEventListener("resize",(()=>{e.updateBounds(),t.setSize(e.bounds.width,e.bounds.height)}),!1);let n,s=performance.now()/1e3,i=!1;const a=()=>{requestAnimationFrame(a);const o=performance.now()/1e3,r=o-s;if(s=o,e.update(r),t.camera.setOrbit(e.look.state[0],e.look.state[1],n.width*e.zoom.state),i)return;const c=t.device.createCommandEncoder();n.compute(c,o),t.render(c,n),t.device.queue.submit([c.finish()])};requestAnimationFrame(a);const c=({code:e,shader:t},n)=>{i=!1;const o=e.split("\n"),r=o.indexOf("// __SOURCE__")+1;t.compilationInfo().then((({messages:e})=>n.set(e.map((({length:e,lineNum:t,linePos:n,message:s,type:a})=>(i=!0,{line:o[t-1],lineNum:t-r,linePos:n,length:e,message:s,pointer:Array.from({length:n-1+e},((e,t)=>t>=n-1?"^":" ")).join(""),type:a}))))))},l=[fe.source.subscribe((e=>{e="// __SOURCE__\n"+e,t.atlas.compute(e),c(t.atlas,fe.errors)})),de.background.subscribe((e=>t.setClearColor(...o(e)))),de.effects.edges.color.subscribe((e=>{t.postprocessing.effects.edges.color=o(e)})),de.effects.edges.intensity.subscribe((e=>{t.postprocessing.effects.edges.intensity=e})),de.resolution.subscribe((e=>{let o;n&&(o=n.source,n.destroy()),n=new Kt({device:t.device,width:e,height:e,depth:e}),o&&(n.source=o,n.setScene({source:o})),_t(t.camera.target,.5*n.width,.5*n.height,.5*n.depth)})),pe.source.subscribe((e=>{n.source=e,e="// __SOURCE__\n"+e,n.setScene({source:e}),c(n.voxelizer,pe.errors)}))];return de.screenshot=(e=512)=>{const n=document.createElement("canvas"),o=n.getContext("2d");n.width=e,n.height=e;let r=0,s=0,i=t.canvas.width,a=t.canvas.height;return i>a?(r=-.5*(a-i),i=a):(s=-.5*(i-a),a=i),o.drawImage(t.canvas,r,s,a,i,0,0,e,e),n.toDataURL()},()=>{l.forEach((e=>e())),e.destroy(),n.destroy(),delete de.screenshot}})),[r,function(e){I[e?"unshift":"push"]((()=>{r=e,n(0,r)}))}]}Qt.sensitivity={look:.003,zoom:3e-4},Qt.minPhi=1e-6,Qt.maxPhi=Math.PI-1e-6,Qt.minZoom=Math.log(.25),Qt.maxZoom=Math.log(1.5),Qt.zoomRange=Qt.maxZoom-Qt.minZoom;class nn extends se{constructor(e){super(),re(this,e,tn,en,s,{})}}const{window:on}=Q;function rn(e){let t,n;return t=new et({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function sn(e){let t,n;return t=new Ke({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function an(e){let t,n;return t=new Xe({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function cn(e){let t,n;return t=new Be({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function ln(e){let t,n;return t=new Me({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function un(e){let t,n,r,s,i,a,c,l,u,f,d,p,v;r=new wt({});const h=[ln,cn,an,sn,rn],m=[];function g(e,t){return"atlas"===e[1]?0:"gallery"===e[1]?1:"publish"===e[1]?2:"rendering"===e[1]?3:"scene"===e[1]?4:-1}return~(i=g(e))&&(a=m[i]=h[i](e)),f=new nn({}),{c(){t=z("div"),n=z("div"),te(r.$$.fragment),s=$(),a&&a.c(),c=$(),l=z("div"),u=$(),te(f.$$.fragment),E(n,"class","ui svelte-efpout"),C(n,"width",e[0]+"px"),E(l,"class","divider svelte-efpout"),E(t,"class","app svelte-efpout")},m(o,a){y(o,t,a),x(t,n),ne(r,n,null),x(n,s),~i&&m[i].m(n,null),x(t,c),x(t,l),x(t,u),ne(f,t,null),d=!0,p||(v=[S(on,"mousemove",e[3]),S(on,"mouseup",e[4]),S(l,"mousedown",e[2])],p=!0)},p(e,[t]){let o=i;i=g(e),i!==o&&(a&&(Z(),K(m[o],1,1,(()=>{m[o]=null})),H()),~i?(a=m[i],a||(a=m[i]=h[i](e),a.c()),J(a,1),a.m(n,null)):a=null),(!d||1&t)&&C(n,"width",e[0]+"px")},i(e){d||(J(r.$$.fragment,e),J(a),J(f.$$.fragment,e),d=!0)},o(e){K(r.$$.fragment,e),K(a),K(f.$$.fragment,e),d=!1},d(e){e&&b(t),oe(r),~i&&m[i].d(),oe(f),p=!1,o(v)}}}function fn(e,t,n){let o;f(e,ue,(e=>n(1,o=e)));let r=800;const s={enabled:!1,initial:0,offset:0};return[r,o,({clientX:e})=>{s.enabled=!0,s.initial=r,s.offset=e},({clientX:e})=>{s.enabled&&(n(0,r=Math.max(Math.floor(s.initial+e-s.offset),500)),O().then((()=>window.dispatchEvent(new Event("resize")))))},()=>{s.enabled&&(s.enabled=!1)}]}class dn extends se{constructor(e){super(),re(this,e,fn,un,s,{})}}function pn(e){let t,n;return t=new dn({}),{c(){te(t.$$.fragment)},m(e,o){ne(t,e,o),n=!0},i(e){n||(J(t.$$.fragment,e),n=!0)},o(e){K(t.$$.fragment,e),n=!1},d(e){oe(t,e)}}}function vn(t){let n;return{c(){n=z("div"),n.innerHTML='Sorry! This works only in <a href="https://www.google.com/chrome/canary/" rel="noopener noreferrer" target="_blank" class="svelte-4omflb">Chrome Canary</a>.',E(n,"class","canary svelte-4omflb")},m(e,t){y(e,n,t)},i:e,o:e,d(e){e&&b(n)}}}function hn(t){let n;return{c(){n=z("div"),n.textContent="Loading...",E(n,"class","loading svelte-4omflb")},m(e,t){y(e,n,t)},i:e,o:e,d(e){e&&b(n)}}}function mn(e){let t,n,o,r,s,i,a;const c=[hn,vn,pn],l=[];function u(e,t){return e[1]?0:e[0]?1:2}return t=u(e),n=l[t]=c[t](e),{c(){n.c(),o=$(),r=z("div"),r.innerHTML='voxeltoy - <a href="https://github.com/danielesteban/voxeltoy" rel="noopener noreferrer" target="_blank" class="svelte-4omflb">view source</a><br/> \n  <a href="https://dani.gatunes.com" rel="noopener noreferrer" target="_blank" class="svelte-4omflb">dani@gatunes</a> © 2022',s=$(),i=z("a"),i.textContent="♥ Become a sponsor",E(r,"class","info svelte-4omflb"),E(i,"class","ribbon svelte-4omflb"),E(i,"href","https://github.com/sponsors/danielesteban"),E(i,"data-ribbon","♥ Become a sponsor"),E(i,"rel","noopener noreferrer"),E(i,"target","_blank")},m(e,n){l[t].m(e,n),y(e,o,n),y(e,r,n),y(e,s,n),y(e,i,n),a=!0},p(e,[r]){let s=t;t=u(e),t!==s&&(Z(),K(l[s],1,1,(()=>{l[s]=null})),H(),n=l[t],n||(n=l[t]=c[t](e),n.c()),J(n,1),n.m(o.parentNode,o))},i(e){a||(J(n),a=!0)},o(e){K(n),a=!1},d(e){l[t].d(e),e&&b(o),e&&b(r),e&&b(s),e&&b(i)}}}function gn(e,t,n){let o;f(e,ue,(e=>n(3,o=e)));let r=!1,s=!0;const i=()=>{const e=location.hash.slice(2).split("/")[0];"gallery"===e?g(ue,o="gallery",o):e?be.load(e).then((e=>{he(e),ue.set("scene")})).catch((()=>{location.hash="/"})):"gallery"===o&&g(ue,o="scene",o)};return Promise.all([(async()=>{if(!navigator.gpu||!navigator.gpu.getPreferredCanvasFormat)throw new Error("WebGPU");const e=await navigator.gpu.requestAdapter(),t=await e.requestDevice();return{adapter:e,device:t}})(),new Promise((e=>{require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs"}}),require(["vs/editor/editor.main"],e)}))]).then((([e])=>{de.gpu=e,window.addEventListener("hashchange",i,!1),i()})).catch((e=>{console.error(e),n(0,r=!0)})).finally((()=>{n(1,s=!1)})),[r,s]}new class extends se{constructor(e){super(),re(this,e,gn,mn,s,{})}}({target:document.body})}();
